{"version":3,"sources":["../../../src/workers/usecases/handle-deliver-to-discord-user-private.ts"],"sourcesContent":["import { ExternalEventsEntity, OrderEntity } from \"@/@shared/db/entities\";\r\nimport { formatPrice } from \"@/@shared/lib\";\r\nimport { getLocalStoreConfig } from \"@/@shared/sharpify\";\r\nimport { ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { ProductCardComponent } from \"@/bot/checkout/components\";\r\nimport { BotConfig } from \"@/config\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport {\r\n\tAPIEmbedField,\r\n\tAttachmentBuilder,\r\n\tButtonBuilder,\r\n\tButtonStyle,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tMessage,\r\n\tMessageCreateOptions,\r\n\tTextChannel,\r\n\tUser,\r\n} from \"discord.js\";\r\nimport {} from \"necord\";\r\n\r\n@Injectable()\r\nexport class HandleDeliverToDiscordUserPrivate {\r\n\tconstructor(@Inject(Client) private readonly client: Client) {}\r\n\r\n\tasync getUserDMChannelEmbed({ orderEntity, user }: { orderEntity: OrderEntity; user: User }): Promise<MessageCreateOptions> {\r\n\t\tconst fields: APIEmbedField[] = [];\r\n\r\n\t\tconst { url } = await getLocalStoreConfig();\r\n\t\tconst ViewOnWebsiteButton = new ButtonBuilder()\r\n\t\t\t.setLabel(\"Visualizar compra no site\") // text on the button\r\n\t\t\t.setStyle(ButtonStyle.Link) // gray button, like in the image\r\n\t\t\t.setEmoji(\"üîó\")\r\n\t\t\t.setURL(`${url}/checkout/${orderEntity.id}`);\r\n\r\n\t\tlet fileAttachments: AttachmentBuilder[] = [];\r\n\t\tfor (const orderItem of orderEntity.orderProps.orderItems) {\r\n\t\t\tfields.push({\r\n\t\t\t\tname: `üõí Produto:`,\r\n\t\t\t\tvalue: `\\`\\`\\`${orderItem.product.backup.title} ${orderItem.product.backup.viewType === \"DYNAMIC\" ? `> ${orderItem.product.itemBackup.title}` : \"\"}\\`\\`\\``,\r\n\t\t\t});\r\n\t\t\tfields.push({\r\n\t\t\t\tname: `Quantidade:`,\r\n\t\t\t\tvalue: `\\`\\`${orderItem.quantity}X\\`\\``,\r\n\t\t\t\tinline: true,\r\n\t\t\t});\r\n\t\t\tfields.push({\r\n\t\t\t\tname: `üíµ Pre√ßo:`,\r\n\t\t\t\tvalue: `\\`\\`${formatPrice(orderItem.pricing.total)}\\`\\``,\r\n\t\t\t\tinline: true,\r\n\t\t\t});\r\n\r\n\t\t\tif (orderItem.product.itemBackup.stockType === \"STATIC\") {\r\n\t\t\t\tif ((orderItem.product?.itemBackup?.stockContent as string)?.length > 1024) {\r\n\t\t\t\t\t// cria um arquivo tempor√°rio com o conte√∫do do estoque\r\n\t\t\t\t\tconst fileContent = `Estoque:\\n${orderItem.product?.itemBackup?.stockContent}`;\r\n\t\t\t\t\tfileAttachments.push(\r\n\t\t\t\t\t\tnew AttachmentBuilder(Buffer.from(fileContent), {\r\n\t\t\t\t\t\t\tname: \"estoque.txt\",\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t);\r\n\t\t\t\t\tfields.push({\r\n\t\t\t\t\t\tname: \"Estoque:\",\r\n\t\t\t\t\t\tvalue: \"üìÑ Estoque muito grande ‚Äî veja o arquivo `estoque.txt` em anexo.\",\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfields.push({\r\n\t\t\t\t\t\tname: `Estoque:`,\r\n\t\t\t\t\t\tvalue: `\\`\\`\\`${orderItem.product.itemBackup.stockContent}\\`\\`\\``,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else if (orderItem.product.itemBackup.stockType === \"LINES\") {\r\n\t\t\t\tconst joined = (orderItem.product.itemBackup.stockContent as any)\r\n\t\t\t\t\t.map((lineStock: string) => `\\`\\`\\`${lineStock}\\`\\`\\``)\r\n\t\t\t\t\t.join(\"\\n\");\r\n\t\t\t\tif (joined.length > 1024) {\r\n\t\t\t\t\tconst fileContent = `Estoques:\\n${joined}`;\r\n\t\t\t\t\tfileAttachments.push(\r\n\t\t\t\t\t\tnew AttachmentBuilder(Buffer.from(fileContent), {\r\n\t\t\t\t\t\t\tname: \"estoques.txt\",\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t);\r\n\t\t\t\t\tfields.push({\r\n\t\t\t\t\t\tname: \"Estoques:\",\r\n\t\t\t\t\t\tvalue: \"üìÑ Lista muito grande ‚Äî veja o arquivo `estoques.txt` em anexo.\",\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfields.push({\r\n\t\t\t\t\t\tname: `Estoque:`,\r\n\t\t\t\t\t\tvalue: joined,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tfields.push({ name: \"\\u200b\", value: \"\" }); // Empty field for spacing\r\n\t\t}\r\n\r\n\t\tconst embed = new EmbedBuilder()\r\n\t\t\t.setDescription(\"Detalhes do pedido...\")\r\n\t\t\t.setColor(BotConfig.color)\r\n\t\t\t.addFields(fields)\r\n\t\t\t.setFooter({ text: \"Obrigado por comprar conosco! ‚ù§Ô∏è\" });\r\n\r\n\t\treturn {\r\n\t\t\tcontent: `Ol√° ${user}! üëã\\nSeu pedido #${orderEntity.orderProps.shortReference} foi entregue com sucesso!`,\r\n\t\t\tembeds: [embed],\r\n\t\t\tcomponents: [{ type: 1, components: [ViewOnWebsiteButton] }],\r\n\t\t\tfiles: fileAttachments,\r\n\t\t};\r\n\t}\r\n\r\n\tasync execute({ orderEntity }: { orderEntity: OrderEntity }) {\r\n\t\t// 1Ô∏è‚É£ Get the user by ID\r\n\t\tconst user = await this.client.users.fetch(orderEntity.customerId).catch(() => null);\r\n\t\tif (!user) {\r\n\t\t\tconsole.warn(`User with ID ${orderEntity.customerId} not found.`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst dm = await user.createDM();\r\n\r\n\t\ttry {\r\n\t\t\tawait dm.send(await this.getUserDMChannelEmbed({ orderEntity, user }));\r\n\t\t} catch (error: any) {\r\n\t\t\tif (error.code === 50007) {\r\n\t\t\t\tconsole.warn(`‚ùå Cannot send DM to user ${orderEntity.customerId}. DMs are closed.`);\r\n\t\t\t\t// Optionally: notify them in a public channel or log internally\r\n\t\t\t} else {\r\n\t\t\t\tconsole.error(\"Unexpected error sending DM:\", error);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tawait orderEntity.markAsDelivered();\r\n\t}\r\n}\r\n"],"names":["HandleDeliverToDiscordUserPrivate","getUserDMChannelEmbed","orderEntity","user","fields","url","getLocalStoreConfig","ViewOnWebsiteButton","ButtonBuilder","setLabel","setStyle","ButtonStyle","Link","setEmoji","setURL","id","fileAttachments","orderItem","orderProps","orderItems","push","name","value","product","backup","title","viewType","itemBackup","quantity","inline","formatPrice","pricing","total","stockType","stockContent","length","fileContent","AttachmentBuilder","Buffer","from","joined","map","lineStock","join","embed","EmbedBuilder","setDescription","setColor","BotConfig","color","addFields","setFooter","text","content","shortReference","embeds","components","type","files","execute","client","users","fetch","customerId","catch","console","warn","dm","createDM","send","error","code","markAsDelivered"],"mappings":"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"}