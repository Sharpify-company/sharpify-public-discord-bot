{"version":3,"sources":["../../../../../src/@shared/db/entities/discord-user/cart.embedded.ts"],"sourcesContent":["import { StoreProps } from \"@/@shared/sharpify/api\";\r\nimport { AfterLoad, Column } from \"typeorm\";\r\nimport { DiscordUserEntity } from \"./_discord-user.entity\";\r\n\r\nexport class CartEmbedded {\r\n\tdiscordUser!: DiscordUserEntity;\r\n\r\n\t@Column({ name: \"cart_channelId\", type: \"text\", nullable: true })\r\n\tchannelId!: string;\r\n\r\n\t@Column({ name: \"cart_messageId\", type: \"text\", nullable: true })\r\n\tmessageId!: string;\r\n\r\n\t@Column({ name: \"cart_items\", type: \"json\", nullable: false, default: \"[]\" })\r\n\tcartItems!: CartEmbedded.CartItem[];\r\n\r\n\t@Column({ name: \"cart_ gatewayMethod\", type: \"text\", nullable: true })\r\n\tgatewayMethod!: StoreProps.GatewayMethodsEnum | null;\r\n\r\n\t@Column({ name: \"cart_couponCode\", type: \"text\", nullable: true })\r\n\tcouponCode!: string | null;\r\n\r\n\t@Column({ name: \"cart_subTotalPrice\", type: \"real\", nullable: false, default: 0 })\r\n\tsubTotalPrice!: number;\r\n\r\n\t@Column({ name: \"cart_totalPrice\", type: \"real\", nullable: false, default: 0 })\r\n\ttotalPrice!: number;\r\n\r\n\t@Column({ name: \"cart_createdAt\", type: \"datetime\", nullable: true })\r\n\tcartCreatedAt!: Date;\r\n\r\n\t@Column({ name: \"cart_isOpened\", type: \"boolean\", nullable: false, default: 0 })\r\n\tisOpened!: boolean;\r\n\r\n\tconstructor(props: CartEmbedded.Props) {\r\n\t\tObject.assign(this, props);\r\n\t}\r\n\r\n\tstatic createDefault() {\r\n\t\treturn new CartEmbedded({\r\n\t\t\tchannelId: null!,\r\n\t\t\tmessageId: null!,\r\n\t\t\tcartItems: [],\r\n\t\t\tcouponCode: null!,\r\n\t\t\tsubTotalPrice: 0,\r\n\t\t\ttotalPrice: 0,\r\n\t\t\tcartCreatedAt: null!,\r\n\t\t\tgatewayMethod: null!,\r\n\t\t\tisOpened: false,\r\n\t\t});\r\n\t}\r\n\r\n\taddToCart(item: Pick<CartEmbedded.CartItem, \"productId\" | \"productItemId\" | \"quantity\">) {\r\n\t\tconst existingItemIndex = this.cartItems.findIndex(\r\n\t\t\t(cartItem) => cartItem.productId === item.productId && cartItem.productItemId === item.productItemId,\r\n\t\t);\r\n\t\tif (existingItemIndex === -1) {\r\n\t\t\tthis.cartItems.push({ ...item, subTotalPrice: 0, totalPrice: 0, isCouponApplied: false });\r\n\t\t}\r\n\r\n\t\tif (!this.isOpened && this.cartItems.length > 0) {\r\n\t\t\tthis.isOpened = true;\r\n\t\t\tthis.cartCreatedAt = new Date();\r\n\t\t}\r\n\t}\r\n\r\n\tasync removeFromCart({ productId, productItemId }: { productId: string; productItemId: string }) {\r\n\t\tthis.cartItems = this.cartItems.filter(\r\n\t\t\t(cartItem) => !(cartItem.productId === productId && cartItem.productItemId === productItemId),\r\n\t\t);\r\n\r\n\t\tif (this.isCartEmpty()) {\r\n\t\t\tthis.isOpened = false;\r\n\t\t\tthis.cartCreatedAt = null!;\r\n\t\t}\r\n\t\tawait this.discordUser.save();\r\n\t}\r\n\r\n\tasync cancelOrder() {\r\n\t\tthis.cartItems = [];\r\n\t\tthis.channelId = null!;\r\n\t\tthis.messageId = null!;\r\n\t\tthis.couponCode = null;\r\n\t\tthis.subTotalPrice = 0;\r\n\t\tthis.totalPrice = 0;\r\n\t\tthis.cartCreatedAt = null!;\r\n\t\tthis.isOpened = false;\r\n\r\n\t\tawait this.discordUser.save();\r\n\t}\r\n\r\n\tasync updateGatewayMethod(gatewayMethod: StoreProps.GatewayMethodsEnum) {\r\n\t\tthis.gatewayMethod = gatewayMethod;\r\n\t\tawait this.discordUser.save();\r\n\t}\r\n\r\n\t@AfterLoad()\r\n\tprivate afterLoad() {\r\n\t\tthis.isOpened = Boolean(this.isOpened);\r\n\t\t// this.cartItems = Array.isArray(this.cartItems) ? this.cartItems : JSON.parse(this.cartItems as unknown as string);\r\n\t}\r\n\r\n\tisCartEmpty() {\r\n\t\treturn this.cartItems.length === 0;\r\n\t}\r\n}\r\n\r\nexport namespace CartEmbedded {\r\n\texport type CartItem = {\r\n\t\tproductId: string;\r\n\t\tproductItemId: string;\r\n\t\tquantity: number;\r\n\t\tsubTotalPrice: number;\r\n\t\ttotalPrice: number;\r\n\t\tisCouponApplied: boolean;\r\n\t};\r\n\r\n\texport type Props = {\r\n\t\tchannelId: string;\r\n\t\tmessageId: string | null;\r\n\t\tcartItems: CartItem[];\r\n\t\tcouponCode: string | null;\r\n\t\tsubTotalPrice: number;\r\n\t\ttotalPrice: number;\r\n\t\tcartCreatedAt: Date | null;\r\n\t\tgatewayMethod: StoreProps.GatewayMethodsEnum | null;\r\n\t\tisOpened: boolean;\r\n\t};\r\n}\r\n"],"names":["CartEmbedded","createDefault","channelId","messageId","cartItems","couponCode","subTotalPrice","totalPrice","cartCreatedAt","gatewayMethod","isOpened","addToCart","item","existingItemIndex","findIndex","cartItem","productId","productItemId","push","isCouponApplied","length","Date","removeFromCart","filter","isCartEmpty","discordUser","save","cancelOrder","updateGatewayMethod","afterLoad","Boolean","props","Object","assign","name","type","nullable","default"],"mappings":";;;;+BAIaA;;;eAAAA;;;yBAHqB;;;;;;;;;;AAG3B,IAAA,AAAMA,eAAN,MAAMA;IAkCZ,OAAOC,gBAAgB;QACtB,OAAO,IAAID,aAAa;YACvBE,WAAW;YACXC,WAAW;YACXC,WAAW,EAAE;YACbC,YAAY;YACZC,eAAe;YACfC,YAAY;YACZC,eAAe;YACfC,eAAe;YACfC,UAAU;QACX;IACD;IAEAC,UAAUC,IAA6E,EAAE;QACxF,MAAMC,oBAAoB,IAAI,CAACT,SAAS,CAACU,SAAS,CACjD,CAACC,WAAaA,SAASC,SAAS,KAAKJ,KAAKI,SAAS,IAAID,SAASE,aAAa,KAAKL,KAAKK,aAAa;QAErG,IAAIJ,sBAAsB,CAAC,GAAG;YAC7B,IAAI,CAACT,SAAS,CAACc,IAAI,CAAC;gBAAE,GAAGN,IAAI;gBAAEN,eAAe;gBAAGC,YAAY;gBAAGY,iBAAiB;YAAM;QACxF;QAEA,IAAI,CAAC,IAAI,CAACT,QAAQ,IAAI,IAAI,CAACN,SAAS,CAACgB,MAAM,GAAG,GAAG;YAChD,IAAI,CAACV,QAAQ,GAAG;YAChB,IAAI,CAACF,aAAa,GAAG,IAAIa;QAC1B;IACD;IAEA,MAAMC,eAAe,EAAEN,SAAS,EAAEC,aAAa,EAAgD,EAAE;QAChG,IAAI,CAACb,SAAS,GAAG,IAAI,CAACA,SAAS,CAACmB,MAAM,CACrC,CAACR,WAAa,CAAEA,CAAAA,SAASC,SAAS,KAAKA,aAAaD,SAASE,aAAa,KAAKA,aAAY;QAG5F,IAAI,IAAI,CAACO,WAAW,IAAI;YACvB,IAAI,CAACd,QAAQ,GAAG;YAChB,IAAI,CAACF,aAAa,GAAG;QACtB;QACA,MAAM,IAAI,CAACiB,WAAW,CAACC,IAAI;IAC5B;IAEA,MAAMC,cAAc;QACnB,IAAI,CAACvB,SAAS,GAAG,EAAE;QACnB,IAAI,CAACF,SAAS,GAAG;QACjB,IAAI,CAACC,SAAS,GAAG;QACjB,IAAI,CAACE,UAAU,GAAG;QAClB,IAAI,CAACC,aAAa,GAAG;QACrB,IAAI,CAACC,UAAU,GAAG;QAClB,IAAI,CAACC,aAAa,GAAG;QACrB,IAAI,CAACE,QAAQ,GAAG;QAEhB,MAAM,IAAI,CAACe,WAAW,CAACC,IAAI;IAC5B;IAEA,MAAME,oBAAoBnB,aAA4C,EAAE;QACvE,IAAI,CAACA,aAAa,GAAGA;QACrB,MAAM,IAAI,CAACgB,WAAW,CAACC,IAAI;IAC5B;IAGQG,YAAY;QACnB,IAAI,CAACnB,QAAQ,GAAGoB,QAAQ,IAAI,CAACpB,QAAQ;IACrC,qHAAqH;IACtH;IAEAc,cAAc;QACb,OAAO,IAAI,CAACpB,SAAS,CAACgB,MAAM,KAAK;IAClC;IAtEA,YAAYW,KAAyB,CAAE;QACtCC,OAAOC,MAAM,CAAC,IAAI,EAAEF;IACrB;AAqED;;;QAlGWG,MAAM;QAAkBC,MAAM;QAAQC,UAAU;;;;;;QAGhDF,MAAM;QAAkBC,MAAM;QAAQC,UAAU;;;;;;QAGhDF,MAAM;QAAcC,MAAM;QAAQC,UAAU;QAAOC,SAAS;;;;;;QAG5DH,MAAM;QAAuBC,MAAM;QAAQC,UAAU;;;;;;QAGrDF,MAAM;QAAmBC,MAAM;QAAQC,UAAU;;;;;;QAGjDF,MAAM;QAAsBC,MAAM;QAAQC,UAAU;QAAOC,SAAS;;;;;;QAGpEH,MAAM;QAAmBC,MAAM;QAAQC,UAAU;QAAOC,SAAS;;;;;;QAGjEH,MAAM;QAAkBC,MAAM;QAAYC,UAAU;;;;;;QAGpDF,MAAM;QAAiBC,MAAM;QAAWC,UAAU;QAAOC,SAAS"}