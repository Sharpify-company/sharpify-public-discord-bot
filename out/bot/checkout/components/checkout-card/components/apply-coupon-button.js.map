{"version":3,"sources":["../../../../../../src/bot/checkout/components/checkout-card/components/apply-coupon-button.ts"],"sourcesContent":["import { forwardRef, Inject, Injectable } from \"@nestjs/common\";\r\nimport {\r\n\tModal,\r\n\tContext,\r\n\tSlashCommand,\r\n\tSlashCommandContext,\r\n\tCtx,\r\n\tModalContext,\r\n\tStringSelect,\r\n\tStringSelectContext,\r\n\tSelectedStrings,\r\n\tButton,\r\n\tComponentParam,\r\n\tModalParam,\r\n} from \"necord\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChatInputCommandInteraction,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tLabelBuilder,\r\n\tMessage,\r\n\tModalActionRowComponentBuilder,\r\n\tModalBuilder,\r\n\tModalSubmitInteraction,\r\n\tStringSelectMenuBuilder,\r\n\tTextChannel,\r\n\tTextInputBuilder,\r\n\tTextInputStyle,\r\n} from \"discord.js\";\r\nimport { BotConfig } from \"@/config\";\r\nimport { ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { formatPrice } from \"@/@shared/lib\";\r\nimport TurndownService from \"turndown\";\r\nimport { DiscordUserEntity, EmojiEntity, ProductEntity } from \"@/@shared/db/entities\";\r\nimport { ValidateDatabaseCartItemsHelper } from \"../../../helpers\";\r\nimport { formatCheckoutCartItemNameHelper, getCheckoutCartItemsHelper } from \"../helper\";\r\nimport { SectionManagerHandler } from \"../section-manager\";\r\nimport { WrapperType } from \"@/@shared/types\";\r\nimport { RemoveFromCartUsecase } from \"../usecases\";\r\nimport { HandleDiscordMemberNotFound } from \"@/@shared/handlers\";\r\nimport { FindEmojiHelper } from \"@/@shared/helpers\";\r\nimport { Sharpify } from \"@/@shared/sharpify\";\r\n\r\n@Injectable()\r\nexport class ApplyCouponButtonComponent {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\t@Inject(forwardRef(() => SectionManagerHandler))\r\n\t\tprivate readonly sectionManagerHandler: WrapperType<SectionManagerHandler>,\r\n\t) {}\r\n\r\n\t@Modal(\"apply_coupon_modal\")\r\n\tpublic async onModalSubmit(@Ctx() [interaction]: ModalContext, @ModalParam(\"productIdAndItemId\") productIdAndItemId: string) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: interaction.user.id });\r\n\t\tif (!discordUser) return await HandleDiscordMemberNotFound({ interaction });\r\n\r\n\t\tconst couponCode = interaction.fields.getTextInputValue(\"couponCodeInput\");\r\n\r\n\t\tconst couponReq = await Sharpify.api.v1.pricing.coupon.validateCoupon({ code: couponCode });\r\n\t\tif (!couponReq.success) {\r\n\t\t\treturn await interaction.reply({\r\n\t\t\t\tcontent: `O código de cupom \"${couponCode}\" é inválido ou expirou.`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tdiscordUser.cart.couponCode = couponCode;\r\n\r\n\t\tawait discordUser.save();\r\n\r\n\t\tawait ValidateDatabaseCartItemsHelper({ discordUserId: discordUser.id });\r\n\r\n\t\tinteraction.deferUpdate();\r\n\t\tconst result = await this.sectionManagerHandler.setSection({\r\n\t\t\tdiscordUserId: interaction.user.id,\r\n\t\t\tsection: \"MAIN\",\r\n\t\t});\r\n\t\tawait interaction.message?.edit(result as any);\r\n\t}\r\n\r\n\t@Button(\"apply_coupon\")\r\n\tprivate async handleButtonClicked(@Context() [interaction]: [ButtonInteraction]) {\r\n\t\tconst modal = new ModalBuilder().setCustomId(`apply_coupon_modal`).setTitle(`Aplicar cupom de desconto`);\r\n\r\n\t\tconst couponCodeInput = new TextInputBuilder()\r\n\t\t\t.setCustomId(\"couponCodeInput\")\r\n\t\t\t.setLabel(`Insira o código do cupom de desconto`)\r\n\t\t\t.setStyle(TextInputStyle.Short)\r\n\t\t\t.setMinLength(1)\r\n\t\t\t.setMaxLength(50)\r\n\t\t\t.setRequired(true);\r\n\r\n\t\tmodal.setComponents(new ActionRowBuilder<ModalActionRowComponentBuilder>().addComponents([couponCodeInput]));\r\n\r\n\t\tawait interaction.showModal(modal);\r\n\t}\r\n\r\n\t@Button(\"remove_coupon\")\r\n\tprivate async handleRemoveCouopn(@Context() [interaction]: [ButtonInteraction]) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: interaction.user.id });\r\n\t\tif (!discordUser) return await HandleDiscordMemberNotFound({ interaction });\r\n\r\n\t\tdiscordUser.cart.couponCode = null;\r\n\r\n\t\tawait discordUser.save();\r\n\r\n\t\tconst result = await this.sectionManagerHandler.setSection({\r\n\t\t\tdiscordUserId: interaction.user.id,\r\n\t\t\tsection: \"MAIN\",\r\n\t\t});\r\n\t\tawait interaction.message?.edit(result as any);\r\n\r\n\t\tawait interaction.deferUpdate();\r\n\t}\r\n\r\n\tasync createButton({ discordUserId }: { discordUserId: string }) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: discordUserId });\r\n\r\n\t\tconst ticketEmoji = await FindEmojiHelper({ client: this.client, name: \"Sharpify_ticket\" });\r\n\r\n\t\tif (discordUser?.cart.couponCode) {\r\n\t\t\tconst RemoveCouponButton = new ButtonBuilder()\r\n\t\t\t\t.setCustomId(`remove_coupon`) // unique ID to handle clicks\r\n\t\t\t\t.setLabel(\"Remover cupom\") // text on the button\r\n\t\t\t\t.setStyle(ButtonStyle.Danger); // gray button, like in the image\r\n\t\t\tticketEmoji && RemoveCouponButton.setEmoji({ id: ticketEmoji.id });\r\n\t\t\treturn { ApplyCouponButton: RemoveCouponButton };\r\n\t\t}\r\n\r\n\t\tconst ApplyCouponButton = new ButtonBuilder()\r\n\t\t\t.setCustomId(`apply_coupon`) // unique ID to handle clicks\r\n\t\t\t.setLabel(\"Aplicar cupom\") // text on the button\r\n\t\t\t.setStyle(ButtonStyle.Secondary); // gray button, like in the image\r\n\t\tticketEmoji && ApplyCouponButton.setEmoji({ id: ticketEmoji.id });\r\n\t\treturn { ApplyCouponButton };\r\n\t}\r\n}\r\n"],"names":["ApplyCouponButtonComponent","onModalSubmit","interaction","productIdAndItemId","discordUser","DiscordUserEntity","findOneBy","id","user","HandleDiscordMemberNotFound","couponCode","fields","getTextInputValue","couponReq","Sharpify","api","v1","pricing","coupon","validateCoupon","code","success","reply","content","flags","cart","save","ValidateDatabaseCartItemsHelper","discordUserId","deferUpdate","result","sectionManagerHandler","setSection","section","message","edit","handleButtonClicked","modal","ModalBuilder","setCustomId","setTitle","couponCodeInput","TextInputBuilder","setLabel","setStyle","TextInputStyle","Short","setMinLength","setMaxLength","setRequired","setComponents","ActionRowBuilder","addComponents","showModal","handleRemoveCouopn","createButton","ticketEmoji","FindEmojiHelper","client","name","RemoveCouponButton","ButtonBuilder","ButtonStyle","Danger","setEmoji","ApplyCouponButton","Secondary","SectionManagerHandler"],"mappings":"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"}