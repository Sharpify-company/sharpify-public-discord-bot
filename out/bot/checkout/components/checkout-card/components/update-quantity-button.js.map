{"version":3,"sources":["../../../../../../src/bot/checkout/components/checkout-card/components/update-quantity-button.ts"],"sourcesContent":["import { forwardRef, Inject, Injectable } from \"@nestjs/common\";\r\nimport {\r\n\tModal,\r\n\tContext,\r\n\tSlashCommand,\r\n\tSlashCommandContext,\r\n\tCtx,\r\n\tModalContext,\r\n\tStringSelect,\r\n\tStringSelectContext,\r\n\tSelectedStrings,\r\n\tButton,\r\n\tComponentParam,\r\n\tModalParam,\r\n} from \"necord\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChatInputCommandInteraction,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tLabelBuilder,\r\n\tMessage,\r\n\tModalActionRowComponentBuilder,\r\n\tModalBuilder,\r\n\tModalSubmitInteraction,\r\n\tTextChannel,\r\n\tTextInputBuilder,\r\n\tTextInputStyle,\r\n} from \"discord.js\";\r\nimport { BotConfig } from \"@/config\";\r\nimport { ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { formatPrice } from \"@/@shared/lib\";\r\nimport TurndownService from \"turndown\";\r\nimport { DiscordUserEntity, ProductEntity } from \"@/@shared/db/entities\";\r\nimport { ValidateDatabaseCartItemsHelper } from \"../../../helpers\";\r\nimport { formatCheckoutCartItemNameHelper, getCheckoutCartItemsHelper } from \"../helper\";\r\nimport { SectionManagerHandler } from \"../section-manager\";\r\nimport { WrapperType } from \"@/@shared/types\";\r\nimport { RemoveFromCartUsecase } from \"../usecases\";\r\n\r\n@Injectable()\r\nexport class UpdateQuantityButtonComponent {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\t@Inject(forwardRef(() => SectionManagerHandler))\r\n\t\tprivate readonly sectionManagerHandler: WrapperType<SectionManagerHandler>,\r\n\t) {}\r\n\r\n\t@Modal(\"update_cart_quantity_modal/:productIdAndItemId\")\r\n\tpublic async onModalSubmit(@Ctx() [interaction]: ModalContext, @ModalParam(\"productIdAndItemId\") productIdAndItemId: string) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: interaction.user.id });\r\n\t\tif (!discordUser) {\r\n\t\t\tawait interaction.reply({\r\n\t\t\t\tcontent: \"Usu치rio n칚o encontrado. Por favor, inicie uma compra primeiro.\",\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst quantity = parseInt(interaction.fields.getTextInputValue(\"quantityInput\"));\r\n\t\tif (isNaN(quantity) || quantity < 1) {\r\n\t\t\tawait interaction.reply({\r\n\t\t\t\tcontent: \"Quantidade inv치lida. Por favor, insira um n칰mero v치lido maior que 0.\",\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst [productId, productItemId] = productIdAndItemId.split(\":\");\r\n\r\n\t\tconst productItems = await getCheckoutCartItemsHelper({ discordUserId: interaction.user.id });\r\n\t\tconst cartItem = productItems.find((v) => v.product.id === productId && v.item.id === productItemId);\r\n\t\tif (!cartItem) {\r\n\t\t\tawait interaction.reply({\r\n\t\t\t\tcontent: \"Item n칚o encontrado no carrinho.\",\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (cartItem.item.inventory.stockQuantity !== null && quantity > cartItem.item.inventory.stockQuantity) {\r\n\t\t\tawait interaction.reply({\r\n\t\t\t\tcontent: `Quantidade inv치lida. A quantidade m치xima dispon칤vel em estoque 칠 ${cartItem.item.inventory.stockQuantity}.`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tdiscordUser.cart.cartItems = discordUser.cart.cartItems.map((v) => {\r\n\t\t\tif (v.productId === productId && v.productItemId === productItemId) {\r\n\t\t\t\tv.quantity = quantity;\r\n\t\t\t}\r\n\t\t\treturn v;\r\n\t\t});\r\n\t\tawait discordUser.save();\r\n\r\n\t\tinteraction.deferUpdate();\r\n\t\tconst result = await this.sectionManagerHandler.setSection({\r\n\t\t\tdiscordUserId: interaction.user.id,\r\n\t\t\tsection: \"CART_ITEM\",\r\n\t\t\tproductId,\r\n\t\t\titemId: productItemId,\r\n\t\t});\r\n\t\tawait interaction.message?.edit(result as any);\r\n\t}\r\n\r\n\t@Button(\"update_quantity/:productIdAndItemId\")\r\n\tprivate async handleButtonClicked(\r\n\t\t@Context() [interaction]: [ButtonInteraction],\r\n\t\t@ComponentParam(\"productIdAndItemId\") productIdAndItemId: string,\r\n\t) {\r\n\t\tconst [productId, productItemId] = productIdAndItemId.split(\":\");\r\n\r\n\t\tconst productItems = await getCheckoutCartItemsHelper({ discordUserId: interaction.user.id });\r\n\t\tconst cartItem = productItems.find((v) => v.product.id === productId && v.item.id === productItemId);\r\n\t\tif (!cartItem) {\r\n\t\t\tawait interaction.reply({\r\n\t\t\t\tcontent: \"Item n칚o encontrado no carrinho.\",\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst modal = new ModalBuilder()\r\n\t\t\t.setCustomId(`update_cart_quantity_modal/${productId}:${productItemId}`)\r\n\t\t\t.setTitle(`Editar quantidade - ${formatCheckoutCartItemNameHelper(cartItem)}`.slice(0, 45));\r\n\r\n\t\tconst quantityInput = new TextInputBuilder()\r\n\t\t\t.setCustomId(\"quantityInput\")\r\n\t\t\t.setLabel(\r\n\t\t\t\t`Insira a nova quantidade. MAX ${cartItem.item.inventory.stockQuantity === null ? \"Ilimitado\" : cartItem.item.inventory.stockQuantity + \" unidades\"}`,\r\n\t\t\t)\r\n\t\t\t.setValue(String(cartItem.quantity))\r\n\t\t\t.setStyle(TextInputStyle.Short)\r\n\t\t\t.setMinLength(1)\r\n\t\t\t.setMaxLength(3)\r\n\t\t\t.setRequired(true);\r\n\r\n\t\tmodal.setComponents(new ActionRowBuilder<ModalActionRowComponentBuilder>().addComponents([quantityInput]));\r\n\r\n\t\tawait interaction.showModal(modal);\r\n\t}\r\n\r\n\tasync createButton({ productId, productItemId }: { productId: string; productItemId: string }) {\r\n\t\tconst UpdateQuantityCartButton = new ButtonBuilder()\r\n\t\t\t.setCustomId(`update_quantity/${productId}:${productItemId}`) // unique ID to handle clicks\r\n\t\t\t.setLabel(\"Editar quantidade\") // text on the button\r\n\t\t\t.setStyle(ButtonStyle.Success) // gray button, like in the image\r\n\t\t\t.setEmoji(\"游닍\");\r\n\t\treturn { UpdateQuantityCartButton };\r\n\t}\r\n}\r\n"],"names":["UpdateQuantityButtonComponent","onModalSubmit","interaction","productIdAndItemId","discordUser","DiscordUserEntity","findOneBy","id","user","reply","content","flags","quantity","parseInt","fields","getTextInputValue","isNaN","productId","productItemId","split","productItems","getCheckoutCartItemsHelper","discordUserId","cartItem","find","v","product","item","inventory","stockQuantity","cart","cartItems","map","save","deferUpdate","result","sectionManagerHandler","setSection","section","itemId","message","edit","handleButtonClicked","modal","ModalBuilder","setCustomId","setTitle","formatCheckoutCartItemNameHelper","slice","quantityInput","TextInputBuilder","setLabel","setValue","String","setStyle","TextInputStyle","Short","setMinLength","setMaxLength","setRequired","setComponents","ActionRowBuilder","addComponents","showModal","createButton","UpdateQuantityCartButton","ButtonBuilder","ButtonStyle","Success","setEmoji","client","SectionManagerHandler"],"mappings":"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"}