{"version":3,"sources":["../../../../src/bot/checkout/helpers/validate-database-cart-items.helper.ts"],"sourcesContent":["import { DiscordUserEntity, ProductEntity } from \"@/@shared/db/entities\";\r\nimport { Either } from \"@/@shared/lib\";\r\nimport { Sharpify } from \"@/@shared/sharpify\";\r\n\r\nexport async function ValidateDatabaseCartItemsHelper({ discordUserId }: { discordUserId: string }) {\r\n\tconst user = await DiscordUserEntity.findOneBy({ id: discordUserId });\r\n\tif (!user) return;\r\n\r\n\tconst productIds = user.cart.cartItems.reduce((acc, item) => {\r\n\t\tif (!acc.includes(item.productId)) {\r\n\t\t\tacc.push(item.productId);\r\n\t\t}\r\n\t\treturn acc;\r\n\t}, [] as string[]);\r\n\r\n\tconst productEntities: ProductEntity[] = [];\r\n\tfor (const productId of productIds) {\r\n\t\tconst product = await ProductEntity.findOneBy({ id: productId });\r\n\t\tproduct && productEntities.push(product);\r\n\t}\r\n\r\n\tfor (const cartItem of user.cart.cartItems) {\r\n\t\tconst product = productEntities.find((p) => p.id === cartItem.productId);\r\n\t\tif (!product) {\r\n\t\t\t// Product no longer exists, remove from cart\r\n\t\t\tuser.cart.removeFromCart({ productId: cartItem.productId, productItemId: cartItem.productItemId });\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst productItem =\r\n\t\t\tproduct.productProps.settings.viewType === \"NORMAL\"\r\n\t\t\t\t? product.productProps.normalItem\r\n\t\t\t\t: product.productProps.dynamicItems.find((v) => v.id === cartItem.productItemId);\r\n\r\n\t\t\t\tif (!productItem) {\r\n\t\t\t\t\t// Product item no longer exists, remove from cart\r\n\t\t\t\t\tconsole.log(\"ðŸš€ ~ ValidateDatabaseCartItemsHelper ~ productItem:\", productItem)\r\n\t\t\tuser.cart.removeFromCart({ productId: cartItem.productId, productItemId: cartItem.productItemId });\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (productItem.inventory.stockQuantity === null) continue;\r\n\t\tif (cartItem.quantity > productItem.inventory.stockQuantity) {\r\n\t\t\t// Adjust quantity to available stock\r\n\t\t\tcartItem.quantity = productItem.inventory.stockQuantity;\r\n\t\t\tif (cartItem.quantity <= 0) {\r\n\t\t\t\tuser.cart.removeFromCart({ productId: cartItem.productId, productItemId: cartItem.productItemId });\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tconst subTotal = user.cart.cartItems.reduce((acc, item) => {\r\n\t\tconst product = productEntities.find((p) => p.id === item.productId);\r\n\t\tif (!product) return acc;\r\n\t\tconst productItem =\r\n\t\t\tproduct.productProps.settings.viewType === \"NORMAL\"\r\n\t\t\t\t? product.productProps.normalItem\r\n\t\t\t\t: product.productProps.dynamicItems.find((v) => v.id === item.productItemId);\r\n\t\tif (!productItem) return acc;\r\n\t\treturn acc + productItem.pricing.price * item.quantity;\r\n\t}, 0);\r\n\tlet total = subTotal;\r\n\r\n\tif (user.cart.couponCode) {\r\n\t\tconst couponReq = await Sharpify.api.v1.pricing.coupon.validateCoupon({ code: user.cart.couponCode });\r\n\t\tif (!couponReq.success) {\r\n\t\t\tuser.cart.couponCode = null;\r\n\t\t} else {\r\n\t\t\tconst coupon = couponReq.data.coupon;\r\n\t\t\tif (coupon.type === \"PERCENTAGE\") {\r\n\t\t\t\ttotal = total - (total * coupon.amout) / 100;\r\n\t\t\t}\r\n\t\t\tif (coupon.type === \"FIXED\") {\r\n\t\t\t\ttotal = total - coupon.amout;\r\n\t\t\t\tif (total < 0) total = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tuser.cart.subTotalPrice = subTotal;\r\n\tuser.cart.totalPrice = total;\r\n\r\n\tawait user.save();\r\n}\r\n"],"names":["ValidateDatabaseCartItemsHelper","discordUserId","user","DiscordUserEntity","findOneBy","id","productIds","cart","cartItems","reduce","acc","item","includes","productId","push","productEntities","product","ProductEntity","cartItem","find","p","removeFromCart","productItemId","productItem","productProps","settings","viewType","normalItem","dynamicItems","v","console","log","inventory","stockQuantity","quantity","subTotal","pricing","price","total","couponCode","couponReq","Sharpify","api","v1","coupon","validateCoupon","code","success","data","type","amout","subTotalPrice","totalPrice","save"],"mappings":"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"}