{"version":3,"sources":["../../src/workers/consume-external-event.worker.ts"],"sourcesContent":["import { ExternalEventsEntity } from \"@/@shared/db/entities\";\r\nimport { Sharpify } from \"@/@shared/sharpify\";\r\nimport { Injectable } from \"@nestjs/common\";\r\nimport { Cron, CronExpression } from \"@nestjs/schedule\";\r\n\r\n@Injectable()\r\nexport class ConsumeExternalEventWorker {\r\n\t@Cron(\"*/15 * * * * *\")\r\n\thandleCron() {\r\n\t\tthis.execute();\r\n\t}\r\n\r\n\tasync execute() {\r\n\t\tconst req = await Sharpify.api.v1.commomServices.externalEvents.listPendingEvents();\r\n\t\tif (!req.success) return console.log(\"Error fetching events:\", req.errorName);\r\n\r\n\t\tfor (const event of req.data.events) {\r\n\t\t\tconst exists = await ExternalEventsEntity.findOneBy({ id: event.id });\r\n\t\t\tif (exists) continue;\r\n\r\n\t\t\tif (!event.id || !event.contextAggregateId || !event.eventName) return;\r\n\r\n\t\t\ttry {\r\n\t\t\t\tawait ExternalEventsEntity.createExternalEvent({\r\n\t\t\t\t\tid: event.id,\r\n\t\t\t\t\tcontextAggregateId: event.contextAggregateId,\r\n\t\t\t\t\teventName: event.eventName,\r\n\t\t\t\t\tpayload: event.payload,\r\n\t\t\t\t}).save();\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconst error = err as any;\r\n\t\t\t\t// Verifica se o erro é de constraint única (SQLite usa o código 'SQLITE_CONSTRAINT')\r\n\t\t\t\tif (error.code === \"SQLITE_CONSTRAINT\" || error.message.includes(\"UNIQUE\")) {\r\n\t\t\t\t\tconsole.log(`Evento ${event.id} já existe, ignorando...`);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Se for outro erro, dispara novamente\r\n\t\t\t\t\tthrow error;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tawait Sharpify.api.v1.commomServices.externalEvents.markAsReceived({ ids: req.data.events.map((e) => e.id) });\r\n\t}\r\n}\r\n"],"names":["ConsumeExternalEventWorker","handleCron","execute","req","Sharpify","api","v1","commomServices","externalEvents","listPendingEvents","success","console","log","errorName","event","data","events","exists","ExternalEventsEntity","findOneBy","id","contextAggregateId","eventName","createExternalEvent","payload","save","err","error","code","message","includes","markAsReceived","ids","map","e"],"mappings":";;;;+BAMaA;;;eAAAA;;;0BANwB;0BACZ;wBACE;0BACU;;;;;;;;;;AAG9B,IAAA,AAAMA,6BAAN,MAAMA;IAEZC,aAAa;QACZ,IAAI,CAACC,OAAO;IACb;IAEA,MAAMA,UAAU;QACf,MAAMC,MAAM,MAAMC,kBAAQ,CAACC,GAAG,CAACC,EAAE,CAACC,cAAc,CAACC,cAAc,CAACC,iBAAiB;QACjF,IAAI,CAACN,IAAIO,OAAO,EAAE,OAAOC,QAAQC,GAAG,CAAC,0BAA0BT,IAAIU,SAAS;QAE5E,KAAK,MAAMC,SAASX,IAAIY,IAAI,CAACC,MAAM,CAAE;YACpC,MAAMC,SAAS,MAAMC,8BAAoB,CAACC,SAAS,CAAC;gBAAEC,IAAIN,MAAMM,EAAE;YAAC;YACnE,IAAIH,QAAQ;YAEZ,IAAI,CAACH,MAAMM,EAAE,IAAI,CAACN,MAAMO,kBAAkB,IAAI,CAACP,MAAMQ,SAAS,EAAE;YAEhE,IAAI;gBACH,MAAMJ,8BAAoB,CAACK,mBAAmB,CAAC;oBAC9CH,IAAIN,MAAMM,EAAE;oBACZC,oBAAoBP,MAAMO,kBAAkB;oBAC5CC,WAAWR,MAAMQ,SAAS;oBAC1BE,SAASV,MAAMU,OAAO;gBACvB,GAAGC,IAAI;YACR,EAAE,OAAOC,KAAK;gBACb,MAAMC,QAAQD;gBACd,qFAAqF;gBACrF,IAAIC,MAAMC,IAAI,KAAK,uBAAuBD,MAAME,OAAO,CAACC,QAAQ,CAAC,WAAW;oBAC3EnB,QAAQC,GAAG,CAAC,CAAC,OAAO,EAAEE,MAAMM,EAAE,CAAC,wBAAwB,CAAC;gBACzD,OAAO;oBACN,uCAAuC;oBACvC,MAAMO;gBACP;YACD;QACD;QACA,MAAMvB,kBAAQ,CAACC,GAAG,CAACC,EAAE,CAACC,cAAc,CAACC,cAAc,CAACuB,cAAc,CAAC;YAAEC,KAAK7B,IAAIY,IAAI,CAACC,MAAM,CAACiB,GAAG,CAAC,CAACC,IAAMA,EAAEd,EAAE;QAAE;IAC5G;AACD"}