{"version":3,"sources":["../../../../../../../src/bot/checkout/components/product-card/usecases/add-to-cart/_add-to-cart.usecase.ts"],"sourcesContent":["import { Sharpify } from \"@/@shared/sharpify\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChannelType,\r\n\tEmbedBuilder,\r\n\tPermissionsBitField,\r\n} from \"discord.js\";\r\nimport { ValidateProduct } from \"./validate-product\";\r\nimport { dotEnv } from \"@/@shared/lib\";\r\nimport { EnsureCartChannelCreated } from \"./ensure-cart-channel-created\";\r\nimport { EnsureUserExistsOnDb } from \"./ensure-user-exists-on-db\";\r\nimport { CheckoutCardComponent } from \"../../../checkout-card/checkout-card\";\r\nimport { CreateReplyToGoToCheckout } from \"./create-reply-to-go-to-checkout\";\r\nimport { ValidateDatabaseCartItemsHelper } from \"@/bot/checkout/helpers\";\r\nimport { Injectable } from \"@nestjs/common\";\r\nimport { ProductEntity } from \"@/@shared/db/entities\";\r\n\r\n@Injectable()\r\nexport class AddToCartUsecase {\r\n\tconstructor(private readonly checkoutCardComponent: CheckoutCardComponent) {}\r\n\r\n\tasync execute(input: { interaction: ButtonInteraction<CacheType>; productId: string; productItemId: string }) {\r\n\t\tconst { interaction } = input;\r\n\r\n\t\tif (!(await ProductEntity.existsBy({ id: input.productId }))) {\r\n\t\t\treturn interaction.reply({\r\n\t\t\t\tcontent: \"❌ Produto não encontrado ou indisponível.\",\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst validateProductResult = await ValidateProduct(input);\r\n\t\tif (validateProductResult.isFailure()) return;\r\n\r\n\t\tconst product = validateProductResult.value;\r\n\r\n\t\tconst ensureUserCreatedResult = await EnsureUserExistsOnDb(input);\r\n\t\tif (ensureUserCreatedResult.isFailure()) return;\r\n\r\n\t\tconst user = ensureUserCreatedResult.value;\r\n\r\n\t\tuser.cart.addToCart({\r\n\t\t\tproductId: product.id,\r\n\t\t\tproductItemId: input.productItemId,\r\n\t\t\tquantity: 1,\r\n\t\t});\r\n\t\tawait user.save();\r\n\r\n\t\tconst ensureCartResult = await EnsureCartChannelCreated({\r\n\t\t\t...input,\r\n\t\t\tuser,\r\n\t\t});\r\n\t\tif (ensureCartResult.isFailure()) return;\r\n\r\n\t\tconst { channel, same: sameChannel } = ensureCartResult.value;\r\n\r\n\t\tawait CreateReplyToGoToCheckout({\r\n\t\t\t...input,\r\n\t\t\tchannel,\r\n\t\t});\r\n\r\n\t\tif (!sameChannel) {\r\n\t\t\tconst checkoutReply = await this.checkoutCardComponent.sendCheckoutCardToChannel({\r\n\t\t\t\tchannel,\r\n\t\t\t\tdiscordUser: user,\r\n\t\t\t});\r\n\t\t\tuser.cart.messageId = checkoutReply.id;\r\n\t\t} else {\r\n\t\t\tawait this.checkoutCardComponent.editCheckoutCardToChannel({\r\n\t\t\t\tchannel,\r\n\t\t\t\tdiscordUser: user,\r\n\t\t\t\tmessageId: user.cart.messageId!,\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tuser.cart.channelId = channel.id;\r\n\t\tawait user.save();\r\n\r\n\t\tawait ValidateDatabaseCartItemsHelper({ discordUserId: user.id });\r\n\t}\r\n}\r\n"],"names":["AddToCartUsecase","execute","input","interaction","ProductEntity","existsBy","id","productId","reply","content","flags","validateProductResult","ValidateProduct","isFailure","product","value","ensureUserCreatedResult","EnsureUserExistsOnDb","user","cart","addToCart","productItemId","quantity","save","ensureCartResult","EnsureCartChannelCreated","channel","same","sameChannel","CreateReplyToGoToCheckout","checkoutReply","checkoutCardComponent","sendCheckoutCardToChannel","discordUser","messageId","editCheckoutCardToChannel","channelId","ValidateDatabaseCartItemsHelper","discordUserId"],"mappings":";;;;+BAsBaA;;;eAAAA;;;iCAXmB;0CAES;sCACJ;8BACC;2CACI;yBACM;wBACrB;0BACG;;;;;;;;;;AAGvB,IAAA,AAAMA,mBAAN,MAAMA;IAGZ,MAAMC,QAAQC,KAA8F,EAAE;QAC7G,MAAM,EAAEC,WAAW,EAAE,GAAGD;QAExB,IAAI,CAAE,MAAME,uBAAa,CAACC,QAAQ,CAAC;YAAEC,IAAIJ,MAAMK,SAAS;QAAC,IAAK;YAC7D,OAAOJ,YAAYK,KAAK,CAAC;gBACxBC,SAAS;gBACTC,OAAO;oBAAC;iBAAY;YACrB;QACD;QAEA,MAAMC,wBAAwB,MAAMC,IAAAA,gCAAe,EAACV;QACpD,IAAIS,sBAAsBE,SAAS,IAAI;QAEvC,MAAMC,UAAUH,sBAAsBI,KAAK;QAE3C,MAAMC,0BAA0B,MAAMC,IAAAA,0CAAoB,EAACf;QAC3D,IAAIc,wBAAwBH,SAAS,IAAI;QAEzC,MAAMK,OAAOF,wBAAwBD,KAAK;QAE1CG,KAAKC,IAAI,CAACC,SAAS,CAAC;YACnBb,WAAWO,QAAQR,EAAE;YACrBe,eAAenB,MAAMmB,aAAa;YAClCC,UAAU;QACX;QACA,MAAMJ,KAAKK,IAAI;QAEf,MAAMC,mBAAmB,MAAMC,IAAAA,kDAAwB,EAAC;YACvD,GAAGvB,KAAK;YACRgB;QACD;QACA,IAAIM,iBAAiBX,SAAS,IAAI;QAElC,MAAM,EAAEa,OAAO,EAAEC,MAAMC,WAAW,EAAE,GAAGJ,iBAAiBT,KAAK;QAE7D,MAAMc,IAAAA,oDAAyB,EAAC;YAC/B,GAAG3B,KAAK;YACRwB;QACD;QAEA,IAAI,CAACE,aAAa;YACjB,MAAME,gBAAgB,MAAM,IAAI,CAACC,qBAAqB,CAACC,yBAAyB,CAAC;gBAChFN;gBACAO,aAAaf;YACd;YACAA,KAAKC,IAAI,CAACe,SAAS,GAAGJ,cAAcxB,EAAE;QACvC,OAAO;YACN,MAAM,IAAI,CAACyB,qBAAqB,CAACI,yBAAyB,CAAC;gBAC1DT;gBACAO,aAAaf;gBACbgB,WAAWhB,KAAKC,IAAI,CAACe,SAAS;YAC/B;QACD;QAEAhB,KAAKC,IAAI,CAACiB,SAAS,GAAGV,QAAQpB,EAAE;QAChC,MAAMY,KAAKK,IAAI;QAEf,MAAMc,IAAAA,wCAA+B,EAAC;YAAEC,eAAepB,KAAKZ,EAAE;QAAC;IAChE;IA5DA,YAAY,AAAiByB,qBAA4C,CAAE;aAA9CA,wBAAAA;IAA+C;AA6D7E"}