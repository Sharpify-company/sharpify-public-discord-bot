{"version":3,"sources":["../../../src/workers/usecases/handle-product-event.ts"],"sourcesContent":["import { ExternalEventsEntity, ProductEntity } from \"@/@shared/db/entities\";\r\nimport { ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { ProductCardComponent } from \"@/bot/checkout/components\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport { Client, TextChannel } from \"discord.js\";\r\nimport {} from \"necord\";\r\n\r\n@Injectable()\r\nexport class HandleProductEvent {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\tprivate readonly productCardComponent: ProductCardComponent,\r\n\t) {}\r\n\r\n\tasync create(externalEventEntity: ExternalEventsEntity) {\r\n\t\tconst payloadProduct: ProductProps = externalEventEntity.payload as ProductProps;\r\n\r\n\t\tconst productEntity = await ProductEntity.findOneBy({ id: externalEventEntity.contextAggregateId });\r\n\t\tif (!productEntity) return;\r\n\r\n\t\tif (externalEventEntity.eventName === \"PRODUCT_DELETED\") {\r\n\t\t\tfor (const channelLiked of productEntity.channelsLinked) {\r\n\t\t\t\tconst channel = (await this.client.channels.fetch(channelLiked.channelId).catch(() => null)) as TextChannel;\r\n\r\n\t\t\t\tif (!channel || !channel.isTextBased()) continue;\r\n\t\t\t\tconst message = await channel.messages.fetch(channelLiked.messageId).catch(() => null);\r\n\t\t\t\tif (!message) continue;\r\n\r\n\t\t\t\tawait message.delete();\r\n\t\t\t}\r\n\r\n\t\t\tawait productEntity.remove();\r\n\t\t} else if (externalEventEntity.eventName === \"PRODUCT_UPDATED\") {\r\n\t\t\tfor (const channelLiked of productEntity.channelsLinked) {\r\n\t\t\t\tconst channel = (await this.client.channels.fetch(channelLiked.channelId).catch(() => null)) as TextChannel;\r\n\t\t\t\tif (!channel || !channel.isTextBased()) continue;\r\n\r\n\t\t\t\tconst message = await channel.messages.fetch(channelLiked.messageId).catch(() => null);\r\n\t\t\t\tif (!message) continue;\r\n\r\n\t\t\t\tconst reply = await this.productCardComponent.getProductCard(payloadProduct);\r\n\r\n\t\t\t\tawait message.edit({\r\n\t\t\t\t\tembeds: [reply.normalEmmbed],\r\n\t\t\t\t\tcomponents: [reply.normalPurchaseButton],\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tawait productEntity.updateProps(payloadProduct);\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["HandleProductEvent","create","externalEventEntity","payloadProduct","payload","productEntity","ProductEntity","findOneBy","id","contextAggregateId","eventName","channelLiked","channelsLinked","channel","client","channels","fetch","channelId","catch","isTextBased","message","messages","messageId","delete","remove","reply","productCardComponent","getProductCard","edit","embeds","normalEmmbed","components","normalPurchaseButton","updateProps"],"mappings":";;;;+BAQaA;;;eAAAA;;;0BARuC;4BAEf;wBACF;yBACC;QACrB;;;;;;;;;;;;;;;AAGR,IAAA,AAAMA,qBAAN,MAAMA;IAMZ,MAAMC,OAAOC,mBAAyC,EAAE;QACvD,MAAMC,iBAA+BD,oBAAoBE,OAAO;QAEhE,MAAMC,gBAAgB,MAAMC,uBAAa,CAACC,SAAS,CAAC;YAAEC,IAAIN,oBAAoBO,kBAAkB;QAAC;QACjG,IAAI,CAACJ,eAAe;QAEpB,IAAIH,oBAAoBQ,SAAS,KAAK,mBAAmB;YACxD,KAAK,MAAMC,gBAAgBN,cAAcO,cAAc,CAAE;gBACxD,MAAMC,UAAW,MAAM,IAAI,CAACC,MAAM,CAACC,QAAQ,CAACC,KAAK,CAACL,aAAaM,SAAS,EAAEC,KAAK,CAAC,IAAM;gBAEtF,IAAI,CAACL,WAAW,CAACA,QAAQM,WAAW,IAAI;gBACxC,MAAMC,UAAU,MAAMP,QAAQQ,QAAQ,CAACL,KAAK,CAACL,aAAaW,SAAS,EAAEJ,KAAK,CAAC,IAAM;gBACjF,IAAI,CAACE,SAAS;gBAEd,MAAMA,QAAQG,MAAM;YACrB;YAEA,MAAMlB,cAAcmB,MAAM;QAC3B,OAAO,IAAItB,oBAAoBQ,SAAS,KAAK,mBAAmB;YAC/D,KAAK,MAAMC,gBAAgBN,cAAcO,cAAc,CAAE;gBACxD,MAAMC,UAAW,MAAM,IAAI,CAACC,MAAM,CAACC,QAAQ,CAACC,KAAK,CAACL,aAAaM,SAAS,EAAEC,KAAK,CAAC,IAAM;gBACtF,IAAI,CAACL,WAAW,CAACA,QAAQM,WAAW,IAAI;gBAExC,MAAMC,UAAU,MAAMP,QAAQQ,QAAQ,CAACL,KAAK,CAACL,aAAaW,SAAS,EAAEJ,KAAK,CAAC,IAAM;gBACjF,IAAI,CAACE,SAAS;gBAEd,MAAMK,QAAQ,MAAM,IAAI,CAACC,oBAAoB,CAACC,cAAc,CAACxB;gBAE7D,MAAMiB,QAAQQ,IAAI,CAAC;oBAClBC,QAAQ;wBAACJ,MAAMK,YAAY;qBAAC;oBAC5BC,YAAY;wBAACN,MAAMO,oBAAoB;qBAAC;gBACzC;YACD;YACA,MAAM3B,cAAc4B,WAAW,CAAC9B;QACjC;IACD;IAxCA,YACC,AAAiCW,MAAc,EAC/C,AAAiBY,oBAA0C,CAC1D;aAFgCZ,SAAAA;aAChBY,uBAAAA;IACf;AAsCJ"}