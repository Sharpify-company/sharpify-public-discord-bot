{"version":3,"sources":["../../../../../../src/bot/checkout/components/checkout-card/usecases/handle-order-approved.usecase.ts"],"sourcesContent":["import { getLocalStoreConfig, Sharpify } from \"@/@shared/sharpify\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChannelType,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tPermissionsBitField,\r\n} from \"discord.js\";\r\nimport { dotEnv } from \"@/@shared/lib\";\r\n\r\nimport { ValidateDatabaseCartItemsHelper } from \"@/bot/checkout/helpers\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport { DiscordUserEntity, OrderEntity } from \"@/@shared/db/entities\";\r\n\r\n@Injectable()\r\nexport class HandleOrderApprovedUsecase {\r\n\tconstructor(@Inject(Client) private readonly client: Client) {}\r\n\r\n\tasync giveRoleToUser({ discordUserId }: { discordUserId: string }) {\r\n\t\tconst guild = await this.client.guilds.fetch(process.env.DISCORD_GUILD_ID!).catch(() => null);\r\n\t\tif (!guild) return;\r\n\r\n\t\tconst member = await guild.members.fetch(discordUserId).catch(() => null);\r\n\t\tif (!member) return;\r\n\r\n\t\tconst store = await getLocalStoreConfig();\r\n\t\tconst rolesToGive = store?.applyRolesSettings || [];\r\n\t\tfor (const roleToGive of rolesToGive) {\r\n\t\t\tconst role = await guild.roles.fetch(roleToGive.roleId).catch(() => null);\r\n\t\t\tif (!role) continue;\r\n\t\t\tconst result = await member.roles.add(role).catch((err) => {\r\n\t\t\t\tconsole.log(err);\r\n\t\t\t\treturn null;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tasync execute({ orderId }: { orderId: string }) {\r\n\t\tconst orderEntity = await OrderEntity.findOneBy({ id: orderId });\r\n\t\tif (!orderEntity) return;\r\n\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: orderEntity.customerId });\r\n\t\tif (!discordUser) return;\r\n\r\n\t\tconst orderChannel = await this.client.channels.fetch(discordUser.cart.channelId!).catch(() => null);\r\n\t\torderChannel && (await orderChannel.delete().catch(() => null));\r\n\r\n\t\tawait orderEntity.markAsPreparingDelivery();\r\n\t\tawait discordUser.cart.cancelOrder();\r\n\t\tawait this.giveRoleToUser({ discordUserId: discordUser.id });\r\n\t}\r\n}\r\n"],"names":["HandleOrderApprovedUsecase","giveRoleToUser","discordUserId","guild","client","guilds","fetch","process","env","DISCORD_GUILD_ID","catch","member","members","store","getLocalStoreConfig","rolesToGive","applyRolesSettings","roleToGive","role","roles","roleId","result","add","err","console","log","execute","orderId","orderEntity","OrderEntity","findOneBy","id","discordUser","DiscordUserEntity","customerId","orderChannel","channels","cart","channelId","delete","markAsPreparingDelivery","cancelOrder"],"mappings":";;;;+BAmBaA;;;eAAAA;;;0BAnBiC;yBAWvC;wBAI4B;0BACY;;;;;;;;;;;;;;;AAGxC,IAAA,AAAMA,6BAAN,MAAMA;IAGZ,MAAMC,eAAe,EAAEC,aAAa,EAA6B,EAAE;QAClE,MAAMC,QAAQ,MAAM,IAAI,CAACC,MAAM,CAACC,MAAM,CAACC,KAAK,CAACC,QAAQC,GAAG,CAACC,gBAAgB,EAAGC,KAAK,CAAC,IAAM;QACxF,IAAI,CAACP,OAAO;QAEZ,MAAMQ,SAAS,MAAMR,MAAMS,OAAO,CAACN,KAAK,CAACJ,eAAeQ,KAAK,CAAC,IAAM;QACpE,IAAI,CAACC,QAAQ;QAEb,MAAME,QAAQ,MAAMC,IAAAA,6BAAmB;QACvC,MAAMC,cAAcF,OAAOG,sBAAsB,EAAE;QACnD,KAAK,MAAMC,cAAcF,YAAa;YACrC,MAAMG,OAAO,MAAMf,MAAMgB,KAAK,CAACb,KAAK,CAACW,WAAWG,MAAM,EAAEV,KAAK,CAAC,IAAM;YACpE,IAAI,CAACQ,MAAM;YACX,MAAMG,SAAS,MAAMV,OAAOQ,KAAK,CAACG,GAAG,CAACJ,MAAMR,KAAK,CAAC,CAACa;gBAClDC,QAAQC,GAAG,CAACF;gBACZ,OAAO;YACR;QACD;IACD;IAEA,MAAMG,QAAQ,EAAEC,OAAO,EAAuB,EAAE;QAC/C,MAAMC,cAAc,MAAMC,qBAAW,CAACC,SAAS,CAAC;YAAEC,IAAIJ;QAAQ;QAC9D,IAAI,CAACC,aAAa;QAElB,MAAMI,cAAc,MAAMC,2BAAiB,CAACH,SAAS,CAAC;YAAEC,IAAIH,YAAYM,UAAU;QAAC;QACnF,IAAI,CAACF,aAAa;QAElB,MAAMG,eAAe,MAAM,IAAI,CAAC/B,MAAM,CAACgC,QAAQ,CAAC9B,KAAK,CAAC0B,YAAYK,IAAI,CAACC,SAAS,EAAG5B,KAAK,CAAC,IAAM;QAC/FyB,gBAAiB,MAAMA,aAAaI,MAAM,GAAG7B,KAAK,CAAC,IAAM;QAEzD,MAAMkB,YAAYY,uBAAuB;QACzC,MAAMR,YAAYK,IAAI,CAACI,WAAW;QAClC,MAAM,IAAI,CAACxC,cAAc,CAAC;YAAEC,eAAe8B,YAAYD,EAAE;QAAC;IAC3D;IAlCA,YAAY,AAAiC3B,MAAc,CAAE;aAAhBA,SAAAA;IAAiB;AAmC/D"}