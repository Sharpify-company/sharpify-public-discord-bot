{"version":3,"sources":["../../../../../src/bot/manual-delivery-confirm/commands/confirm-delivery/confirm-delivery.command.ts"],"sourcesContent":["import { Inject, Injectable, Logger, UseInterceptors } from \"@nestjs/common\";\r\nimport { ButtonBuilder, ButtonStyle, Client, EmbedBuilder, Integration, User } from \"discord.js\";\r\nimport { Context, Options, SlashCommand, SlashCommandContext, StringOption, UserOption } from \"necord\";\r\nimport { getLocalStoreConfig, Sharpify } from \"@/@shared/sharpify\";\r\nimport { BotConfig } from \"@/config\";\r\nimport TurndownService from \"turndown\";\r\nimport { dotEnv, formatPrice } from \"@/@shared/lib\";\r\nimport { OrderAutocompleteInterceptor } from \"./auto-complete-order.interceptor\";\r\nimport { OrderEntity } from \"@/@shared/db/entities\";\r\n\r\nexport class InputDto {\r\n\t@StringOption({\r\n\t\tname: \"venda\",\r\n\t\tdescription: \"ID da venda a ser confirmada\",\r\n\t\trequired: true,\r\n\t\tmax_length: 100,\r\n\t\tautocomplete: true,\r\n\t})\r\n\torderId!: string;\r\n\r\n\t@StringOption({\r\n\t\tname: \"item\",\r\n\t\tdescription: \"Item da venda a ser confirmado\",\r\n\t\trequired: true,\r\n\t\tmax_length: 100,\r\n\t\tautocomplete: true,\r\n\t})\r\n\torderItemId!: string;\r\n\r\n\t@UserOption({\r\n\t\tname: \"usuario\",\r\n\t\tdescription: \"Usu√°rio que recebeu a entrega\",\r\n\t\trequired: true,\r\n\t})\r\n\tuser!: User;\r\n}\r\n\r\n@Injectable()\r\nexport class ConfirmDeliveryCommand {\r\n\tconstructor(@Inject(Client) private readonly client: Client) {}\r\n\r\n\t@UseInterceptors(OrderAutocompleteInterceptor)\r\n\t@SlashCommand({\r\n\t\tname: \"confirmar-entrega\",\r\n\t\tdescription: \"Mande um log publico de confirma√ß√£o de entrega de um produto!\",\r\n\t\tdefaultMemberPermissions: [\"Administrator\"],\r\n\t})\r\n\tpublic async onListOrder(@Context() [interaction]: SlashCommandContext, @Options() { orderId, orderItemId, user }: InputDto) {\r\n\t\tconst order = await Sharpify.api.v1.checkout.order.getOrder({\r\n\t\t\torderId,\r\n\t\t});\r\n\r\n\t\tif (!order.success) {\r\n\t\t\treturn interaction.reply({\r\n\t\t\t\tcontent: `Error ao buscar a venda: ${order.errorName}`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst orderItem = order.data.order.orderItems.find((item) => item.id === orderItemId);\r\n\r\n\t\tif (!orderItem) {\r\n\t\t\treturn interaction.reply({\r\n\t\t\t\tcontent: `Error ao buscar o item da venda.`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst storeEntity = await getLocalStoreConfig();\r\n\r\n\t\tconst preferences = storeEntity.getPreferences();\r\n\r\n\t\tif (!preferences.confirmDelivery.enabled) {\r\n\t\t\treturn interaction.reply({\r\n\t\t\t\tcontent: `O log publico de confirma√ß√£o de entrega n√£o est√° habilitado nas prefer√™ncias da loja.`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst guild = await this.client.guilds.fetch(dotEnv.DISCORD_GUILD_ID).catch(() => null);\r\n\t\tif (!guild) {\r\n\t\t\treturn interaction.reply({\r\n\t\t\t\tcontent: `Error ao buscar o servidor do Discord.`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst channel = await guild.channels.fetch(preferences.confirmDelivery.channelId!).catch(() => null);\r\n\t\tif (!channel || !channel.isTextBased()) {\r\n\t\t\treturn interaction.reply({\r\n\t\t\t\tcontent: `Error ao buscar o canal de log publico de confirma√ß√£o de entrega.`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst emmbed = new EmbedBuilder()\r\n\t\t\t.setColor(BotConfig.color)\r\n\t\t\t.setTitle(\"Entrega Confirmada!\")\r\n\t\t\t.setDescription(\r\n\t\t\t\t`Pedido entregue pelo administrador ${interaction.user} para o cliente ${user}.`,\r\n\t\t\t);\r\n\r\n\t\tconst productName =\r\n\t\t\torderItem.product.backup.viewType === \"NORMAL\"\r\n\t\t\t\t? orderItem.product.backup.title\r\n\t\t\t\t: `${orderItem.product.backup.title} > ${orderItem.product.itemBackup.title}`;\r\n\r\n\t\temmbed.addFields(\r\n\t\t\t{ name: \"üÜî Refer√™ncia\", value: `\\`\\`\\`#${order.data.order.shortReference}\\`\\`\\``, inline: false },\r\n\t\t\t{ name: \"üåê Produto\", value: `\\`\\`\\`${productName}\\`\\`\\``, inline: true },\r\n\t\t\t{ name: \"üì¶ Quantidade\", value: `\\`\\`\\`${orderItem.quantity}\\`\\`\\``, inline: true },\r\n\t\t);\r\n\r\n\t\tconst viewProductButton = new ButtonBuilder()\r\n\t\t\t.setLabel(\"Visualizar produto no site\")\r\n\t\t\t.setStyle(ButtonStyle.Link)\r\n\t\t\t.setURL(`${storeEntity.url}/product/${orderItem.product.productId}`);\r\n\r\n\t\tawait channel.send({\r\n\t\t\tcontent: `${user}`,\r\n\t\t\tembeds: [emmbed],\r\n\t\t\tcomponents: [{ type: 1, components: [viewProductButton] }],\r\n\t\t});\r\n\r\n\t\treturn interaction.reply({\r\n\t\t\tcontent: `Confirma√ß√£o de entrega enviada com sucesso para o canal ${channel}.`,\r\n\t\t\tflags: [\"Ephemeral\"],\r\n\t\t});\r\n\t}\r\n}\r\n"],"names":["ConfirmDeliveryCommand","InputDto","name","description","required","max_length","autocomplete","onListOrder","interaction","orderId","orderItemId","user","order","Sharpify","api","v1","checkout","getOrder","success","reply","content","errorName","flags","orderItem","data","orderItems","find","item","id","storeEntity","getLocalStoreConfig","preferences","getPreferences","confirmDelivery","enabled","guild","client","guilds","fetch","dotEnv","DISCORD_GUILD_ID","catch","channel","channels","channelId","isTextBased","emmbed","EmbedBuilder","setColor","BotConfig","color","setTitle","setDescription","productName","product","backup","viewType","title","itemBackup","addFields","value","shortReference","inline","quantity","viewProductButton","ButtonBuilder","setLabel","setStyle","ButtonStyle","Link","setURL","url","productId","send","embeds","components","type","defaultMemberPermissions"],"mappings":"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"}