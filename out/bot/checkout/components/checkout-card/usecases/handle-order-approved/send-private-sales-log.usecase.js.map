{"version":3,"sources":["../../../../../../../src/bot/checkout/components/checkout-card/usecases/handle-order-approved/send-private-sales-log.usecase.ts"],"sourcesContent":["import { getLocalStoreConfig, Sharpify } from \"@/@shared/sharpify\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChannelType,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tGuildMember,\r\n\tPermissionsBitField,\r\n\tTextChannel,\r\n} from \"discord.js\";\r\nimport { dotEnv, formatPrice } from \"@/@shared/lib\";\r\n\r\nimport { ValidateDatabaseCartItemsHelper } from \"@/bot/checkout/helpers\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport { DiscordUserEntity, OrderEntity } from \"@/@shared/db/entities\";\r\nimport { get } from \"http\";\r\nimport { BotConfig } from \"@/config\";\r\nimport { OrderProps } from \"@/@shared/sharpify/api\";\r\nimport { FindEmojiHelper } from \"@/@shared/helpers\";\r\n\r\nconst sentMessages = new Set<string>();\r\n\r\n@Injectable()\r\nexport class SendPrivateSalesLogUsecase {\r\n\tconstructor(@Inject(Client) private readonly client: Client) {}\r\n\r\n\tasync execute({ discordUserId, orderProps }: SendPrivateSalesLogUsecase.Input) {\r\n\t\tif (sentMessages.has(orderProps.shortReference)) return;\r\n\t\tconst storeEntity = await getLocalStoreConfig();\r\n\t\tconst storePreferences = storeEntity.getPreferences();\r\n\t\tif (!storePreferences.publicLogSales.enabled) return;\r\n\r\n\t\tconst guild = await this.client.guilds.fetch(process.env.DISCORD_GUILD_ID!).catch(() => null);\r\n\t\tif (!guild) return;\r\n\r\n\t\tlet member: GuildMember | null = null;\r\n\r\n\t\tmember = discordUserId ? await guild.members.fetch(discordUserId).catch(() => null) : null;\r\n\t\tif (storePreferences.publicLogSales.onlyDiscordSales && !member) return;\r\n\r\n\t\tconst channel = (await guild.channels.fetch(storePreferences.publicLogSales.channelId!).catch(() => null)) as TextChannel;\r\n\t\tif (!channel || channel.type !== ChannelType.GuildText) return;\r\n\r\n\t\tconst embed = new EmbedBuilder()\r\n\t\t\t.setColor(BotConfig.color)\r\n\t\t\t.setTitle(\"üõí Nova compra feita. (Log privado)\")\r\n\t\t\t.setDescription(`Compra feito com successo e com seguran√ßa.`);\r\n\r\n\t\tembed.addFields([\r\n\t\t\t{\r\n\t\t\t\tname: \"`üÜî` ID do pedido:\",\r\n\t\t\t\tvalue: `\\`\\`\\`#${orderProps.id}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"`üÜî` Refer√™ncia do pedido:\",\r\n\t\t\t\tvalue: `\\`\\`\\`#${orderProps.shortReference}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"`üì¶` Produtos comprado:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${orderProps.orderItems.map((item) => `„Éª ${item.product.backup.title}${item.product.backup.viewType === \"DYNAMIC\" ? ` > ${item.product.itemBackup?.title}` : \"\"} (${item.quantity}x)`).join(\"\\n\")}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t]);\r\n\r\n\t\tembed.addFields([\r\n\t\t\t{\r\n\t\t\t\tname: `Email:`,\r\n\t\t\t\tvalue: `\\`\\`\\`${orderProps.customer.email}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: `Nome:`,\r\n\t\t\t\tvalue: `\\`\\`\\`${orderProps.customer.firstName || \"Sem Nome\"} ${orderProps.customer.lastName || \"Sem ultimo nome\"}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: `M√©todo de pagamento:`,\r\n\t\t\t\tvalue: `\\`\\`\\`${orderProps.payment?.gateway?.name || \"Sem m√©todo de pagamento\"}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"`üìÖ` Pedido feito em:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${new Date(orderProps.createdAt).toLocaleString(\"pt-br\")}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"`üí∏` Valor total:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${formatPrice(orderProps.pricing.total)}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t]);\r\n\r\n\t\tif (member) {\r\n\t\t\tembed.addFields([\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"`üë§` Comprador:\",\r\n\t\t\t\t\tvalue: `${member} ‚ù§Ô∏è`,\r\n\t\t\t\t},\r\n\t\t\t]);\r\n\t\t}\r\n\r\n\t\tconst viewOnWebsiteButton = new ButtonBuilder()\r\n\t\t\t.setLabel(`Visualizar no site`)\r\n\t\t\t.setStyle(ButtonStyle.Link)\r\n\t\t\t.setURL(`${storeEntity.url}/checkout/${orderProps.id}`);\r\n\r\n\t\tawait channel\r\n\t\t\t.send({ embeds: [embed], components: [new ActionRowBuilder<ButtonBuilder>().addComponents(viewOnWebsiteButton)] })\r\n\t\t\t.catch((err) => console.log(err));\r\n\t\tsentMessages.add(orderProps.shortReference);\r\n\t}\r\n}\r\n\r\nexport namespace SendPrivateSalesLogUsecase {\r\n\texport interface Input {\r\n\t\tdiscordUserId?: string;\r\n\t\torderProps: OrderProps;\r\n\t}\r\n}\r\n"],"names":["SendPrivateSalesLogUsecase","sentMessages","Set","execute","discordUserId","orderProps","has","shortReference","storeEntity","getLocalStoreConfig","storePreferences","getPreferences","publicLogSales","enabled","guild","client","guilds","fetch","process","env","DISCORD_GUILD_ID","catch","member","members","onlyDiscordSales","channel","channels","channelId","type","ChannelType","GuildText","embed","EmbedBuilder","setColor","BotConfig","color","setTitle","setDescription","addFields","name","value","id","orderItems","map","item","product","backup","title","viewType","itemBackup","quantity","join","customer","email","firstName","lastName","payment","gateway","Date","createdAt","toLocaleString","formatPrice","pricing","total","viewOnWebsiteButton","ButtonBuilder","setLabel","setStyle","ButtonStyle","Link","setURL","url","send","embeds","components","ActionRowBuilder","addComponents","err","console","log","add"],"mappings":"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"}