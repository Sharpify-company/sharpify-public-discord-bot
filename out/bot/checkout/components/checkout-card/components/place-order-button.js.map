{"version":3,"sources":["../../../../../../src/bot/checkout/components/checkout-card/components/place-order-button.ts"],"sourcesContent":["import { forwardRef, Inject, Injectable } from \"@nestjs/common\";\r\nimport {\r\n\tModal,\r\n\tContext,\r\n\tSlashCommand,\r\n\tSlashCommandContext,\r\n\tCtx,\r\n\tModalContext,\r\n\tStringSelect,\r\n\tStringSelectContext,\r\n\tSelectedStrings,\r\n\tButton,\r\n\tComponentParam,\r\n\tModalParam,\r\n} from \"necord\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChatInputCommandInteraction,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tLabelBuilder,\r\n\tMessage,\r\n\tModalActionRowComponentBuilder,\r\n\tModalBuilder,\r\n\tModalSubmitInteraction,\r\n\tTextChannel,\r\n\tTextInputBuilder,\r\n\tTextInputStyle,\r\n} from \"discord.js\";\r\nimport { BotConfig } from \"@/config\";\r\nimport { ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { dotEnv, formatPrice } from \"@/@shared/lib\";\r\nimport TurndownService from \"turndown\";\r\nimport { DiscordUserEntity, EmojiEntity, OrderEntity, ProductEntity } from \"@/@shared/db/entities\";\r\nimport { ValidateDatabaseCartItemsHelper } from \"../../../helpers\";\r\nimport { formatCheckoutCartItemNameHelper, getCheckoutCartItemsHelper } from \"../helper\";\r\nimport { SectionManagerHandler } from \"../section-manager\";\r\nimport { WrapperType } from \"@/@shared/types\";\r\nimport { HandleOrderApprovedUsecase, RemoveFromCartUsecase } from \"../usecases\";\r\nimport { Sharpify } from \"@/@shared/sharpify\";\r\nimport { HandleDiscordMemberNotFound } from \"@/@shared/handlers\";\r\nimport { FindEmojiHelper } from \"@/@shared/helpers\";\r\n\r\nfunction isValidEmail(email: string): boolean {\r\n\tconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n\treturn emailRegex.test(email);\r\n}\r\n\r\n@Injectable()\r\nexport class PlaceOrderButtonComponent {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\tprivate readonly handleOrderApprovedUsecase: HandleOrderApprovedUsecase,\r\n\t\t@Inject(forwardRef(() => SectionManagerHandler))\r\n\t\tprivate readonly sectionManagerHandler: WrapperType<SectionManagerHandler>,\r\n\t) {}\r\n\r\n\t@Modal(\"place_order_modal\")\r\n\tpublic async onModalSubmit(@Ctx() [interaction]: ModalContext) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: interaction.user.id });\r\n\t\tif (!discordUser) return await HandleDiscordMemberNotFound({ interaction });\r\n\r\n\t\tconst firstName = interaction.fields.getTextInputValue(\"firstNameInput\");\r\n\t\tconst lastName = interaction.fields.getTextInputValue(\"lastNameInput\");\r\n\t\tconst email = interaction.fields.getTextInputValue(\"emailInput\");\r\n\t\tif (!isValidEmail(email)) {\r\n\t\t\tawait interaction.reply({\r\n\t\t\t\tcontent: \"Por favor, insira um email válido.\",\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tawait discordUser.personalInfo.updateInfo({\r\n\t\t\tfirstName,\r\n\t\t\tlastName,\r\n\t\t\temail,\r\n\t\t});\r\n\r\n\t\tconst loadinEmoji = await FindEmojiHelper({ client: this.client, name: \"Sharpify_carregando\" });\r\n\t\tawait interaction.message?.edit({\r\n\t\t\tembeds: [new EmbedBuilder().setDescription(`${loadinEmoji} Processando seu pedido...`).setColor(BotConfig.color)],\r\n\t\t\tcomponents: [],\r\n\t\t});\r\n\t\tawait interaction.deferReply({ flags: [\"Ephemeral\"] });\r\n\r\n\t\tconst placeOrderResult = await Sharpify.api.v1.checkout.order.placeOrder({\r\n\t\t\tstoreId: dotEnv.STORE_ID,\r\n\t\t\taffiliateCode: null,\r\n\t\t\tcouponCode: discordUser.cart.couponCode || null,\r\n\t\t\tpayment: {\r\n\t\t\t\tgatewayMethod: discordUser.cart.gatewayMethod || \"PIX\",\r\n\t\t\t},\r\n\t\t\tcustomer: {\r\n\t\t\t\tfirstName: discordUser.personalInfo.firstName!,\r\n\t\t\t\tlastName: discordUser.personalInfo.lastName!,\r\n\t\t\t\temail: discordUser.personalInfo.email!,\r\n\t\t\t},\r\n\t\t\tproducts: discordUser.cart.cartItems.map((item) => ({\r\n\t\t\t\tproductId: item.productId,\r\n\t\t\t\tproductItemId: item.productItemId,\r\n\t\t\t\tquantity: item.quantity,\r\n\t\t\t})),\r\n\t\t});\r\n\t\tif (!placeOrderResult.success) {\r\n\t\t\tconst result = await this.sectionManagerHandler.setSection({\r\n\t\t\t\tdiscordUserId: interaction.user.id,\r\n\t\t\t\tsection: \"MAIN\",\r\n\t\t\t});\r\n\t\t\tawait interaction.message?.edit(result as any);\r\n\r\n\t\t\tawait interaction.followUp({\r\n\t\t\t\tcontent: `❌ Não foi possível processar seu pedido: ${placeOrderResult.errorName}`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst orderEntity = OrderEntity.createOrder({\r\n\t\t\tid: placeOrderResult.data.orderId,\r\n\t\t\tcustomerId: discordUser.id,\r\n\t\t\tdeliveryStatus: \"PENDING\",\r\n\t\t\torderProps: placeOrderResult.data.order,\r\n\t\t});\r\n\t\tawait orderEntity.save();\r\n\r\n\t\tif (placeOrderResult.data.isApproved) {\r\n\t\t\tif(interaction.replied || interaction.deferred) {\r\n\t\t\t\tawait interaction.editReply({\r\n\t\t\t\t\tcontent: `Pagamento aprovado! Seu pedido #${orderEntity.id} foi confirmado com sucesso.`,\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tawait interaction.followUp({\r\n\t\t\t\t\tcontent: `Pagamento aprovado! Seu pedido #${orderEntity.id} foi confirmado com sucesso.`,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t// interaction.followUp({\r\n\t\t\t// \tcontent: `Pagamento aprovado! Seu pedido #${orderEntity.id} foi confirmado com sucesso.`,\r\n\t\t\t// \tflags: [\"Ephemeral\"],\r\n\t\t\t// });\r\n\t\t\treturn await this.handleOrderApprovedUsecase.execute({\r\n\t\t\t\torderId: orderEntity.id,\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst result = await this.sectionManagerHandler.setSection({\r\n\t\t\tdiscordUserId: interaction.user.id,\r\n\t\t\tsection: \"CHECKOUT\",\r\n\t\t\torderEntity,\r\n\t\t});\r\n\t\tawait interaction.message?.edit(result as any);\r\n\t\tawait interaction.followUp({\r\n\t\t\tcontent: `✅ pagamento criado com sucesso! .`,\r\n\t\t\tflags: [\"Ephemeral\"],\r\n\t\t});\r\n\t}\r\n\r\n\t@Button(\"place_order\")\r\n\tprivate async handleButtonClicked(@Context() [interaction]: [ButtonInteraction]) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: interaction.user.id });\r\n\t\tif (!discordUser) return await HandleDiscordMemberNotFound({ interaction });\r\n\r\n\t\tconst modal = new ModalBuilder().setCustomId(`place_order_modal`).setTitle(`Informações do pagador`);\r\n\r\n\t\tconst defaultFirstName = discordUser.personalInfo.firstName || interaction.user?.displayName?.split(\" \")?.at(0)\r\n\t\tconst defaultLastName = discordUser.personalInfo.lastName || interaction.user?.username\r\n\r\n\t\tconst firstNameInput = new TextInputBuilder()\r\n\t\t\t.setCustomId(\"firstNameInput\")\r\n\t\t\t.setLabel(`Nome`)\r\n\t\t\t.setStyle(TextInputStyle.Short)\r\n\t\t\t.setMinLength(1)\r\n\t\t\t.setMaxLength(40)\r\n\t\t\t.setRequired(true);\r\n\t\tif (defaultFirstName) firstNameInput.setValue(defaultFirstName);\r\n\r\n\t\tconst lastNameInput = new TextInputBuilder()\r\n\t\t\t.setCustomId(\"lastNameInput\")\r\n\t\t\t.setLabel(`Ultimo nome`)\r\n\t\t\t.setStyle(TextInputStyle.Short)\r\n\t\t\t.setMinLength(1)\r\n\t\t\t.setMaxLength(40)\r\n\t\t\t.setRequired(true);\r\n\t\tif (defaultLastName) lastNameInput.setValue(defaultLastName);\r\n\r\n\t\tconst emailInput = new TextInputBuilder()\r\n\t\t\t.setCustomId(\"emailInput\")\r\n\t\t\t.setLabel(`Email`)\r\n\t\t\t.setStyle(TextInputStyle.Short)\r\n\t\t\t.setMinLength(1)\r\n\t\t\t.setMaxLength(150)\r\n\t\t\t.setRequired(true);\r\n\t\tif (discordUser.personalInfo.email) emailInput.setValue(discordUser.personalInfo.email);\r\n\r\n\t\tmodal.setComponents(\r\n\t\t\tnew ActionRowBuilder<ModalActionRowComponentBuilder>().addComponents([firstNameInput]),\r\n\t\t\tnew ActionRowBuilder<ModalActionRowComponentBuilder>().addComponents([lastNameInput]),\r\n\t\t\tnew ActionRowBuilder<ModalActionRowComponentBuilder>().addComponents([emailInput]),\r\n\t\t);\r\n\r\n\t\tawait interaction.showModal(modal);\r\n\t}\r\n\r\n\tasync createButton({ discordUserId }: { discordUserId: string }) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: discordUserId });\r\n\r\n\t\tconst checkEmoji = await FindEmojiHelper({ client: this.client, name: \"Sharpify_aceitar\" });\r\n\r\n\t\tconst PlaceOrderButton = new ButtonBuilder()\r\n\t\t\t.setCustomId(`place_order`) // unique ID to handle clicks\r\n\t\t\t.setLabel(`Finalizar compra`) // text on the button\r\n\t\t\t.setStyle(ButtonStyle.Success) // gray button, like in the image\r\n\t\t\t.setDisabled(!discordUser || !discordUser.cart.gatewayMethod);\r\n\t\tcheckEmoji && PlaceOrderButton.setEmoji({ id: checkEmoji.id });\r\n\t\treturn { PlaceOrderButton };\r\n\t}\r\n}\r\n"],"names":["PlaceOrderButtonComponent","isValidEmail","email","emailRegex","test","onModalSubmit","interaction","discordUser","DiscordUserEntity","findOneBy","id","user","HandleDiscordMemberNotFound","firstName","fields","getTextInputValue","lastName","reply","content","flags","personalInfo","updateInfo","loadinEmoji","FindEmojiHelper","client","name","message","edit","embeds","EmbedBuilder","setDescription","setColor","BotConfig","color","components","deferReply","placeOrderResult","Sharpify","api","v1","checkout","order","placeOrder","storeId","dotEnv","STORE_ID","affiliateCode","couponCode","cart","payment","gatewayMethod","customer","products","cartItems","map","item","productId","productItemId","quantity","success","result","sectionManagerHandler","setSection","discordUserId","section","followUp","errorName","orderEntity","OrderEntity","createOrder","data","orderId","customerId","deliveryStatus","orderProps","save","isApproved","replied","deferred","editReply","handleOrderApprovedUsecase","execute","handleButtonClicked","modal","ModalBuilder","setCustomId","setTitle","defaultFirstName","displayName","split","at","defaultLastName","username","firstNameInput","TextInputBuilder","setLabel","setStyle","TextInputStyle","Short","setMinLength","setMaxLength","setRequired","setValue","lastNameInput","emailInput","setComponents","ActionRowBuilder","addComponents","showModal","createButton","checkEmoji","PlaceOrderButton","ButtonBuilder","ButtonStyle","Success","setDisabled","setEmoji","SectionManagerHandler"],"mappings":"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"}