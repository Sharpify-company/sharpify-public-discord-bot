{"version":3,"sources":["../../../../../../src/bot/checkout/components/checkout-card/components/select-payment-method.ts"],"sourcesContent":["import { forwardRef, Inject, Injectable } from \"@nestjs/common\";\r\nimport {\r\n\tModal,\r\n\tContext,\r\n\tSlashCommand,\r\n\tSlashCommandContext,\r\n\tCtx,\r\n\tModalContext,\r\n\tStringSelect,\r\n\tStringSelectContext,\r\n\tSelectedStrings,\r\n} from \"necord\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tCacheType,\r\n\tChatInputCommandInteraction,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tMessage,\r\n\tModalActionRowComponentBuilder,\r\n\tModalBuilder,\r\n\tModalSubmitInteraction,\r\n\tStringSelectMenuBuilder,\r\n\tTextChannel,\r\n\tTextInputBuilder,\r\n\tTextInputStyle,\r\n} from \"discord.js\";\r\nimport { BotConfig } from \"@/config\";\r\nimport { ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { formatPrice } from \"@/@shared/lib\";\r\nimport TurndownService from \"turndown\";\r\nimport { DiscordUserEntity, EmojiEntity, ProductEntity } from \"@/@shared/db/entities\";\r\nimport { ValidateDatabaseCartItemsHelper } from \"../../../helpers\";\r\nimport { formatCheckoutCartItemNameHelper, getCheckoutCartItemsHelper } from \"../helper\";\r\nimport { SectionManagerHandler } from \"../section-manager\";\r\nimport { WrapperType } from \"@/@shared/types\";\r\nimport { getLocalStoreConfig, Sharpify } from \"@/@shared/sharpify\";\r\nimport { FindEmojiHelper } from \"@/@shared/helpers\";\r\n\r\n@Injectable()\r\nexport class SelectPaymentMethodComponent {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\t@Inject(forwardRef(() => SectionManagerHandler))\r\n\t\tprivate readonly sectionManagerHandler: WrapperType<SectionManagerHandler>,\r\n\t) {}\r\n\r\n\t@StringSelect(\"gateway_method_selected\")\r\n\tprivate async handleItemSelected(@Context() [interaction]: StringSelectContext, @SelectedStrings() selected: string[]) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: interaction.user.id });\r\n\t\tif (discordUser) {\r\n\t\t\tdiscordUser.cart.gatewayMethod = selected[0]! as any;\r\n\t\t\tawait discordUser.save();\r\n\t\t}\r\n\r\n\t\tconst result = await this.sectionManagerHandler.setSection({\r\n\t\t\tdiscordUserId: interaction.user.id,\r\n\t\t\tsection: \"MAIN\",\r\n\t\t});\r\n\r\n\t\tawait interaction.deferUpdate();\r\n\t\tawait interaction.message.edit(result as any);\r\n\t}\r\n\r\n\tasync createSelect({ discordUserId }: { discordUserId: string }) {\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: discordUserId });\r\n\r\n\t\tconst storeConfig = await getLocalStoreConfig();\r\n\r\n\t\tconst defaultGatewayMethod = discordUser?.cart.gatewayMethod || storeConfig.paymentGateways.at(0)?.gatewayMethod || null;\r\n\r\n\t\tif (discordUser && defaultGatewayMethod) {\r\n\t\t\tawait discordUser?.cart.updateGatewayMethod(defaultGatewayMethod);\r\n\t\t}\r\n\r\n\t\tconst options = await Promise.all(\r\n\t\t\tstoreConfig.paymentGateways.map(async (item, index) => {\r\n\t\t\t\tconst result: any = {\r\n\t\t\t\t\tlabel: \"Metodo desconhecido\",\r\n\t\t\t\t\tdescription: `Metodo desconhecido.`,\r\n\t\t\t\t\tvalue: item.gatewayMethod,\r\n\t\t\t\t\tdefault: defaultGatewayMethod === item.gatewayMethod,\r\n\t\t\t\t};\r\n\t\t\t\tif (item.gatewayMethod === \"PIX\") {\r\n\t\t\t\t\tconst pixEmoji = await FindEmojiHelper({ client: this.client, name: \"Sharpify_pix\" });\r\n\t\t\t\t\tresult.emoji = { id: pixEmoji?.id };\r\n\t\t\t\t\tresult.label = \"Método de pagamento PIX\";\r\n\t\t\t\t\tresult.description = `Pague via PIX utilizando nosso gerenciador de pagamentos.`;\r\n\t\t\t\t} else if (item.gatewayMethod === \"EFI_PAY_PREFERENCE\") {\r\n\t\t\t\t\tconst efiEmoji = await FindEmojiHelper({ client: this.client, name: \"Sharpify_efibank\" });\r\n\t\t\t\t\tresult.emoji = { id: efiEmoji?.id };\r\n\t\t\t\t\tresult.label = \"Link de pagamento EFI Bank\";\r\n\t\t\t\t\tresult.description = `Pague via cartão de crédito utilizando nosso gerenciador de pagamentos.`;\r\n\t\t\t\t}\r\n\t\t\t\treturn result;\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\tconst selectMenu = new StringSelectMenuBuilder()\r\n\t\t\t.setCustomId(`gateway_method_selected`)\r\n\t\t\t.setPlaceholder(\"Selecione o método de pagamento\")\r\n\t\t\t.addOptions(options);\r\n\r\n\t\tconst selectPaymentMethod = new ActionRowBuilder<StringSelectMenuBuilder>().addComponents(selectMenu);\r\n\r\n\t\treturn { selectPaymentMethod };\r\n\t}\r\n}\r\n"],"names":["SelectPaymentMethodComponent","handleItemSelected","interaction","selected","discordUser","DiscordUserEntity","findOneBy","id","user","cart","gatewayMethod","save","result","sectionManagerHandler","setSection","discordUserId","section","deferUpdate","message","edit","createSelect","storeConfig","getLocalStoreConfig","defaultGatewayMethod","paymentGateways","at","updateGatewayMethod","options","Promise","all","map","item","index","label","description","value","default","pixEmoji","FindEmojiHelper","client","name","emoji","efiEmoji","selectMenu","StringSelectMenuBuilder","setCustomId","setPlaceholder","addOptions","selectPaymentMethod","ActionRowBuilder","addComponents","SectionManagerHandler"],"mappings":";;;;+BAwCaA;;;eAAAA;;;wBAxCkC;wBAWxC;yBAeA;0BAKuD;gCAGxB;uBACV;0BACkB;yBACd;;;;;;;;;;;;;;;AAGzB,IAAA,AAAMA,+BAAN,MAAMA;IAOZ,MACcC,mBAAmB,AAAW,CAACC,YAAiC,EAAE,AAAmBC,QAAkB,EAAE;QACtH,MAAMC,cAAc,MAAMC,2BAAiB,CAACC,SAAS,CAAC;YAAEC,IAAIL,YAAYM,IAAI,CAACD,EAAE;QAAC;QAChF,IAAIH,aAAa;YAChBA,YAAYK,IAAI,CAACC,aAAa,GAAGP,QAAQ,CAAC,EAAE;YAC5C,MAAMC,YAAYO,IAAI;QACvB;QAEA,MAAMC,SAAS,MAAM,IAAI,CAACC,qBAAqB,CAACC,UAAU,CAAC;YAC1DC,eAAeb,YAAYM,IAAI,CAACD,EAAE;YAClCS,SAAS;QACV;QAEA,MAAMd,YAAYe,WAAW;QAC7B,MAAMf,YAAYgB,OAAO,CAACC,IAAI,CAACP;IAChC;IAEA,MAAMQ,aAAa,EAAEL,aAAa,EAA6B,EAAE;QAChE,MAAMX,cAAc,MAAMC,2BAAiB,CAACC,SAAS,CAAC;YAAEC,IAAIQ;QAAc;QAE1E,MAAMM,cAAc,MAAMC,IAAAA,6BAAmB;QAE7C,MAAMC,uBAAuBnB,aAAaK,KAAKC,iBAAiBW,YAAYG,eAAe,CAACC,EAAE,CAAC,IAAIf,iBAAiB;QAEpH,IAAIN,eAAemB,sBAAsB;YACxC,MAAMnB,aAAaK,KAAKiB,oBAAoBH;QAC7C;QAEA,MAAMI,UAAU,MAAMC,QAAQC,GAAG,CAChCR,YAAYG,eAAe,CAACM,GAAG,CAAC,OAAOC,MAAMC;YAC5C,MAAMpB,SAAc;gBACnBqB,OAAO;gBACPC,aAAa,CAAC,oBAAoB,CAAC;gBACnCC,OAAOJ,KAAKrB,aAAa;gBACzB0B,SAASb,yBAAyBQ,KAAKrB,aAAa;YACrD;YACA,IAAIqB,KAAKrB,aAAa,KAAK,OAAO;gBACjC,MAAM2B,WAAW,MAAMC,IAAAA,wBAAe,EAAC;oBAAEC,QAAQ,IAAI,CAACA,MAAM;oBAAEC,MAAM;gBAAe;gBACnF5B,OAAO6B,KAAK,GAAG;oBAAElC,IAAI8B,UAAU9B;gBAAG;gBAClCK,OAAOqB,KAAK,GAAG;gBACfrB,OAAOsB,WAAW,GAAG,CAAC,yDAAyD,CAAC;YACjF,OAAO,IAAIH,KAAKrB,aAAa,KAAK,sBAAsB;gBACvD,MAAMgC,WAAW,MAAMJ,IAAAA,wBAAe,EAAC;oBAAEC,QAAQ,IAAI,CAACA,MAAM;oBAAEC,MAAM;gBAAmB;gBACvF5B,OAAO6B,KAAK,GAAG;oBAAElC,IAAImC,UAAUnC;gBAAG;gBAClCK,OAAOqB,KAAK,GAAG;gBACfrB,OAAOsB,WAAW,GAAG,CAAC,uEAAuE,CAAC;YAC/F;YACA,OAAOtB;QACR;QAGD,MAAM+B,aAAa,IAAIC,gCAAuB,GAC5CC,WAAW,CAAC,CAAC,uBAAuB,CAAC,EACrCC,cAAc,CAAC,mCACfC,UAAU,CAACpB;QAEb,MAAMqB,sBAAsB,IAAIC,yBAAgB,GAA4BC,aAAa,CAACP;QAE1F,OAAO;YAAEK;QAAoB;IAC9B;IAjEA,YACC,AAAiCT,MAAc,EAC/C,AACiB1B,qBAAyD,CACzE;aAHgC0B,SAAAA;aAEhB1B,wBAAAA;IACf;AA8DJ;;;;;;;;;;;;;;;iEAhE2BsC,qCAAqB"}