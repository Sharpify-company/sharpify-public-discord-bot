{"version":3,"sources":["../../../src/workers/usecases/handle-checkout-event.ts"],"sourcesContent":["import { ExternalEventsEntity, OrderEntity } from \"@/@shared/db/entities\";\r\nimport { getLocalStoreConfig } from \"@/@shared/sharpify\";\r\nimport { OrderProps, ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { ProductCardComponent } from \"@/bot/checkout/components\";\r\nimport { HandleOrderApprovedUsecase, HandleOrderCancelledUsecase } from \"@/bot/checkout/components/checkout-card/usecases\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport { Client, TextChannel } from \"discord.js\";\r\nimport {} from \"necord\";\r\n\r\n@Injectable()\r\nexport class HandleCheckoutEvent {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\tprivate readonly handleOrderApprovedUsecase: HandleOrderApprovedUsecase,\r\n\t\tprivate readonly HandleOrderCancelledUsecase: HandleOrderCancelledUsecase,\r\n\t) {}\r\n\r\n\tasync create(externalEventEntity: ExternalEventsEntity) {\r\n\t\tconst payloadOrder: OrderProps = externalEventEntity.payload as OrderProps;\r\n\t\tconst orderEntity = await OrderEntity.findOneBy({ id: externalEventEntity.contextAggregateId });\r\n\t\tif (!orderEntity) {\r\n\t\t\tif (externalEventEntity.eventName === \"ORDER_APPROVED\") {\r\n\t\t\t\tif (payloadOrder.customer.info?.platform?.discordId) {\r\n\t\t\t\t\tawait this.handleOrderApprovedUsecase.giveRoleToUser({\r\n\t\t\t\t\t\tdiscordUserId: payloadOrder.customer.info.platform.discordId,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tawait this.handleOrderApprovedUsecase.sendPublicSalesLog({\r\n\t\t\t\t\torderProps: payloadOrder,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tawait this.handleOrderApprovedUsecase.sendPrivateSalesLog({\r\n\t\t\t\t\torderProps: payloadOrder,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (orderEntity.deliveryStatus !== \"PENDING\") return;\r\n\r\n\t\tif (externalEventEntity.eventName === \"ORDER_APPROVED\") {\r\n\t\t\tawait orderEntity.updateOrderProps(payloadOrder);\r\n\t\t\tawait this.handleOrderApprovedUsecase.execute({ orderId: orderEntity.id });\r\n\t\t}\r\n\r\n\t\tif (externalEventEntity.eventName === \"ORDER_CANCELLED\") {\r\n\t\t\tawait orderEntity.updateOrderProps(payloadOrder);\r\n\t\t\tthis.HandleOrderCancelledUsecase.execute({ discordUserId: orderEntity.customerId });\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["HandleCheckoutEvent","create","externalEventEntity","payloadOrder","payload","orderEntity","OrderEntity","findOneBy","id","contextAggregateId","eventName","customer","info","platform","discordId","handleOrderApprovedUsecase","giveRoleToUser","discordUserId","sendPublicSalesLog","orderProps","sendPrivateSalesLog","deliveryStatus","updateOrderProps","execute","orderId","HandleOrderCancelledUsecase","customerId","client"],"mappings":";;;;+BAUaA;;;eAAAA;;;0BAVqC;0BAIsB;wBACrC;yBACC;QACrB;;;;;;;;;;;;;;;AAGR,IAAA,AAAMA,sBAAN,MAAMA;IAOZ,MAAMC,OAAOC,mBAAyC,EAAE;QACvD,MAAMC,eAA2BD,oBAAoBE,OAAO;QAC5D,MAAMC,cAAc,MAAMC,qBAAW,CAACC,SAAS,CAAC;YAAEC,IAAIN,oBAAoBO,kBAAkB;QAAC;QAC7F,IAAI,CAACJ,aAAa;YACjB,IAAIH,oBAAoBQ,SAAS,KAAK,kBAAkB;gBACvD,IAAIP,aAAaQ,QAAQ,CAACC,IAAI,EAAEC,UAAUC,WAAW;oBACpD,MAAM,IAAI,CAACC,0BAA0B,CAACC,cAAc,CAAC;wBACpDC,eAAed,aAAaQ,QAAQ,CAACC,IAAI,CAACC,QAAQ,CAACC,SAAS;oBAC7D;gBACD;gBAEA,MAAM,IAAI,CAACC,0BAA0B,CAACG,kBAAkB,CAAC;oBACxDC,YAAYhB;gBACb;gBAEA,MAAM,IAAI,CAACY,0BAA0B,CAACK,mBAAmB,CAAC;oBACzDD,YAAYhB;gBACb;YACD;YACA;QACD;QAEA,IAAIE,YAAYgB,cAAc,KAAK,WAAW;QAE9C,IAAInB,oBAAoBQ,SAAS,KAAK,kBAAkB;YACvD,MAAML,YAAYiB,gBAAgB,CAACnB;YACnC,MAAM,IAAI,CAACY,0BAA0B,CAACQ,OAAO,CAAC;gBAAEC,SAASnB,YAAYG,EAAE;YAAC;QACzE;QAEA,IAAIN,oBAAoBQ,SAAS,KAAK,mBAAmB;YACxD,MAAML,YAAYiB,gBAAgB,CAACnB;YACnC,IAAI,CAACsB,2BAA2B,CAACF,OAAO,CAAC;gBAAEN,eAAeZ,YAAYqB,UAAU;YAAC;QAClF;IACD;IAvCA,YACC,AAAiCC,MAAc,EAC/C,AAAiBZ,0BAAsD,EACvE,AAAiBU,2BAAwD,CACxE;aAHgCE,SAAAA;aAChBZ,6BAAAA;aACAU,8BAAAA;IACf;AAoCJ"}