{"version":3,"sources":["../../src/websocket/handle-external-event.ws.ts"],"sourcesContent":["import { ExternalEventsEntity, OrderEntity } from \"@/@shared/db/entities\";\r\nimport { Sharpify } from \"@/@shared/sharpify\";\r\nimport { ExternalEventsProps } from \"@/@shared/sharpify/api\";\r\nimport { WsProps } from \"@/@shared/types\";\r\nimport { WsClientService } from \"@/app.ws.service\";\r\nimport { Injectable, OnModuleInit } from \"@nestjs/common\";\r\nimport { Cron } from \"@nestjs/schedule\";\r\n\r\n@Injectable()\r\nexport class HandleExternalEventWs implements OnModuleInit {\r\n\tconstructor(private readonly wsClientService: WsClientService) {}\r\n\r\n\tonModuleInit() {\r\n\t\tthis.wsClientService\r\n\t\t\t.on<\r\n\t\t\t\tWsProps<{ externalEvent: ExternalEventsProps }>\r\n\t\t\t>(\"commom_services:external_integration_events:external_event_created\")\r\n\t\t\t.subscribe(async ({ payload: { externalEvent: event } }) => {\r\n\t\t\t\tconst exists = await ExternalEventsEntity.findOneBy({ id: event.id });\r\n\t\t\t\tif (exists) return;\r\n\r\n\t\t\t\tif (!event.id || !event.contextAggregateId || !event.eventName) return;\r\n\r\n\t\t\t\ttry {\r\n\t\t\t\t\tawait ExternalEventsEntity.createExternalEvent({\r\n\t\t\t\t\t\tid: event.id,\r\n\t\t\t\t\t\tcontextAggregateId: event.contextAggregateId,\r\n\t\t\t\t\t\teventName: event.eventName,\r\n\t\t\t\t\t\tpayload: event.payload,\r\n\t\t\t\t\t}).save();\r\n\t\t\t\t} catch (err) {\r\n\t\t\t\t\tconst error = err as any;\r\n\t\t\t\t\t// Verifica se o erro é de constraint única (SQLite usa o código 'SQLITE_CONSTRAINT')\r\n\t\t\t\t\tif (error.code === \"SQLITE_CONSTRAINT\" || error.message.includes(\"UNIQUE\")) {\r\n\t\t\t\t\t\tconsole.log(`Evento ${event.id} já existe, ignorando...`);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// Se for outro erro, dispara novamente\r\n\t\t\t\t\t\tthrow error;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t}\r\n}\r\n"],"names":["HandleExternalEventWs","onModuleInit","wsClientService","on","subscribe","payload","externalEvent","event","exists","ExternalEventsEntity","findOneBy","id","contextAggregateId","eventName","createExternalEvent","save","err","error","code","message","includes","console","log"],"mappings":";;;;+BASaA;;;eAAAA;;;0BATqC;8BAIlB;wBACS;;;;;;;;;;AAIlC,IAAA,AAAMA,wBAAN,MAAMA;IAGZC,eAAe;QACd,IAAI,CAACC,eAAe,CAClBC,EAAE,CAED,sEACDC,SAAS,CAAC,OAAO,EAAEC,SAAS,EAAEC,eAAeC,KAAK,EAAE,EAAE;YACtD,MAAMC,SAAS,MAAMC,8BAAoB,CAACC,SAAS,CAAC;gBAAEC,IAAIJ,MAAMI,EAAE;YAAC;YACnE,IAAIH,QAAQ;YAEZ,IAAI,CAACD,MAAMI,EAAE,IAAI,CAACJ,MAAMK,kBAAkB,IAAI,CAACL,MAAMM,SAAS,EAAE;YAEhE,IAAI;gBACH,MAAMJ,8BAAoB,CAACK,mBAAmB,CAAC;oBAC9CH,IAAIJ,MAAMI,EAAE;oBACZC,oBAAoBL,MAAMK,kBAAkB;oBAC5CC,WAAWN,MAAMM,SAAS;oBAC1BR,SAASE,MAAMF,OAAO;gBACvB,GAAGU,IAAI;YACR,EAAE,OAAOC,KAAK;gBACb,MAAMC,QAAQD;gBACd,qFAAqF;gBACrF,IAAIC,MAAMC,IAAI,KAAK,uBAAuBD,MAAME,OAAO,CAACC,QAAQ,CAAC,WAAW;oBAC3EC,QAAQC,GAAG,CAAC,CAAC,OAAO,EAAEf,MAAMI,EAAE,CAAC,wBAAwB,CAAC;gBACzD,OAAO;oBACN,uCAAuC;oBACvC,MAAMM;gBACP;YACD;QACD;IACF;IA/BA,YAAY,AAAiBf,eAAgC,CAAE;aAAlCA,kBAAAA;IAAmC;AAgCjE"}