{"version":3,"sources":["../../../../../../../src/bot/checkout/components/product-card/usecases/add-to-cart/ensure-cart-channel-created.ts"],"sourcesContent":["import { dotEnv, Either, failure, success } from '@/@shared/lib';\r\nimport { AddToCartUsecase } from './_add-to-cart.usecase';\r\nimport { ProductProps } from '@/@shared/sharpify/api';\r\nimport { Sharpify } from '@/@shared/sharpify';\r\nimport {\r\n  ChannelType,\r\n  InteractionResponse,\r\n  PermissionsBitField,\r\n  TextChannel,\r\n} from 'discord.js';\r\nimport { DiscordUserEntity } from '@/@shared/db/entities';\r\n\r\nexport async function EnsureCartChannelCreated({\r\n  interaction,\r\n  user,\r\n}: Parameters<typeof AddToCartUsecase.prototype.execute>[0] & {\r\n  user: DiscordUserEntity;\r\n}): Promise<\r\n  Either<InteractionResponse, { channel: TextChannel; same: boolean }>\r\n> {\r\n  const member = interaction.member;\r\n  if (!member?.user) {\r\n    return failure(\r\n      await interaction.reply({\r\n        content: `Erro ao identificar usuÃ¡rio.`,\r\n        flags: ['Ephemeral'],\r\n      }),\r\n    );\r\n  }\r\n\r\n  const guild = interaction.guild;\r\n  if (!guild) {\r\n    return failure(\r\n      await interaction.reply({\r\n        content: `Erro ao identificar servidor.`,\r\n        flags: ['Ephemeral'],\r\n      }),\r\n    );\r\n  }\r\n\r\n  const channelParrent = await interaction.client.channels.cache.get(\r\n    dotEnv.CHECKOUT_CATEGORY_ID,\r\n  );\r\n  if (!channelParrent) {\r\n    return failure(\r\n      await interaction.reply({\r\n        content: `Erro ao identificar a categoria do servidor.`,\r\n        flags: ['Ephemeral'],\r\n      }),\r\n    );\r\n  }\r\n\r\n  if (channelParrent.type !== ChannelType.GuildCategory) {\r\n    return failure(\r\n      await interaction.reply({\r\n        content: `Erro ao identificar a categoria do servidor: Categoria invÃ¡lida.`,\r\n        flags: ['Ephemeral'],\r\n      }),\r\n    );\r\n  }\r\n\r\n  if (user.cart.channelId) {\r\n    const existingChannel = guild.channels.cache.get(user.cart.channelId);\r\n    if (existingChannel)\r\n      return success({ channel: existingChannel as TextChannel, same: true });\r\n  }\r\n\r\n  // Create the channel\r\n  const textChannel = await guild.channels.create({\r\n    name: `ðŸ›’   ---   ${member.user.username}`,\r\n    type: ChannelType.GuildText,\r\n    parent: channelParrent,\r\n    permissionOverwrites: [\r\n      {\r\n        id: guild.id, // everyone\r\n        deny: [PermissionsBitField.Flags.ViewChannel],\r\n      },\r\n      {\r\n        id: member.user.id,\r\n        allow: [\r\n          PermissionsBitField.Flags.ViewChannel,\r\n          PermissionsBitField.Flags.ReadMessageHistory,\r\n        ],\r\n      },\r\n    ],\r\n  });\r\n\r\n  return success({ channel: textChannel, same: false });\r\n}\r\n"],"names":["EnsureCartChannelCreated","interaction","user","member","failure","reply","content","flags","guild","channelParrent","client","channels","cache","get","dotEnv","CHECKOUT_CATEGORY_ID","type","ChannelType","GuildCategory","cart","channelId","existingChannel","success","channel","same","textChannel","create","name","username","GuildText","parent","permissionOverwrites","id","deny","PermissionsBitField","Flags","ViewChannel","allow","ReadMessageHistory"],"mappings":";;;;+BAYsBA;;;eAAAA;;;qBAZ2B;yBAS1C;AAGA,eAAeA,yBAAyB,EAC7CC,WAAW,EACXC,IAAI,EAGL;IAGC,MAAMC,SAASF,YAAYE,MAAM;IACjC,IAAI,CAACA,QAAQD,MAAM;QACjB,OAAOE,IAAAA,YAAO,EACZ,MAAMH,YAAYI,KAAK,CAAC;YACtBC,SAAS,CAAC,4BAA4B,CAAC;YACvCC,OAAO;gBAAC;aAAY;QACtB;IAEJ;IAEA,MAAMC,QAAQP,YAAYO,KAAK;IAC/B,IAAI,CAACA,OAAO;QACV,OAAOJ,IAAAA,YAAO,EACZ,MAAMH,YAAYI,KAAK,CAAC;YACtBC,SAAS,CAAC,6BAA6B,CAAC;YACxCC,OAAO;gBAAC;aAAY;QACtB;IAEJ;IAEA,MAAME,iBAAiB,MAAMR,YAAYS,MAAM,CAACC,QAAQ,CAACC,KAAK,CAACC,GAAG,CAChEC,WAAM,CAACC,oBAAoB;IAE7B,IAAI,CAACN,gBAAgB;QACnB,OAAOL,IAAAA,YAAO,EACZ,MAAMH,YAAYI,KAAK,CAAC;YACtBC,SAAS,CAAC,4CAA4C,CAAC;YACvDC,OAAO;gBAAC;aAAY;QACtB;IAEJ;IAEA,IAAIE,eAAeO,IAAI,KAAKC,oBAAW,CAACC,aAAa,EAAE;QACrD,OAAOd,IAAAA,YAAO,EACZ,MAAMH,YAAYI,KAAK,CAAC;YACtBC,SAAS,CAAC,gEAAgE,CAAC;YAC3EC,OAAO;gBAAC;aAAY;QACtB;IAEJ;IAEA,IAAIL,KAAKiB,IAAI,CAACC,SAAS,EAAE;QACvB,MAAMC,kBAAkBb,MAAMG,QAAQ,CAACC,KAAK,CAACC,GAAG,CAACX,KAAKiB,IAAI,CAACC,SAAS;QACpE,IAAIC,iBACF,OAAOC,IAAAA,YAAO,EAAC;YAAEC,SAASF;YAAgCG,MAAM;QAAK;IACzE;IAEA,qBAAqB;IACrB,MAAMC,cAAc,MAAMjB,MAAMG,QAAQ,CAACe,MAAM,CAAC;QAC9CC,MAAM,CAAC,WAAW,EAAExB,OAAOD,IAAI,CAAC0B,QAAQ,EAAE;QAC1CZ,MAAMC,oBAAW,CAACY,SAAS;QAC3BC,QAAQrB;QACRsB,sBAAsB;YACpB;gBACEC,IAAIxB,MAAMwB,EAAE;gBACZC,MAAM;oBAACC,4BAAmB,CAACC,KAAK,CAACC,WAAW;iBAAC;YAC/C;YACA;gBACEJ,IAAI7B,OAAOD,IAAI,CAAC8B,EAAE;gBAClBK,OAAO;oBACLH,4BAAmB,CAACC,KAAK,CAACC,WAAW;oBACrCF,4BAAmB,CAACC,KAAK,CAACG,kBAAkB;iBAC7C;YACH;SACD;IACH;IAEA,OAAOhB,IAAAA,YAAO,EAAC;QAAEC,SAASE;QAAaD,MAAM;IAAM;AACrD"}