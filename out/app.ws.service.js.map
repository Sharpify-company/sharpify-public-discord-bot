{"version":3,"sources":["../src/app.ws.service.ts"],"sourcesContent":["// ws-client.service.ts\r\nimport { Injectable, OnModuleDestroy } from \"@nestjs/common\";\r\nimport { io, Socket } from \"socket.io-client\";\r\nimport { Subject, Observable } from \"rxjs\";\r\nimport { dotEnv } from \"./@shared/lib\";\r\n\r\nlet isLogged = false;\r\n\r\n@Injectable()\r\nexport class WsClientService implements OnModuleDestroy {\r\n\tprivate socket: Socket | null = null;\r\n\r\n\tprivate reconnectTimeout = 3000; // 3s\r\n\tprivate reconnectTimer: NodeJS.Timeout | null = null;\r\n\r\n\tprivate failedAttempts = 0;\r\n\tprivate readonly MAX_FAIL_LOG = 15;\r\n\r\n\tprivate url = dotEnv.NODE_ENV === \"development\" ? \"http://localhost:1000\" : \"https://ws.sharpify.com.br\";\r\n\r\n\tprivate messages$ = new Subject<any>();\r\n\r\n\tconstructor() {\r\n\t\tthis.connect();\r\n\t}\r\n\r\n\tprivate connect() {\r\n\t\t// Evita múltiplas conexões simultâneas\r\n\t\tif (this.socket?.connected) return;\r\n\r\n\t\tthis.socket = io(this.url, {\r\n\t\t\ttransports: [\"websocket\"],\r\n\t\t\tquery: {\r\n\t\t\t\taccessToken: dotEnv.API_TOKEN,\r\n\t\t\t\tconnectionType: \"STORE\",\r\n\t\t\t},\r\n\t\t\tauth: {\r\n\t\t\t\ttoken: dotEnv.API_TOKEN,\r\n\t\t\t\tconnectionType: \"STORE\",\r\n\t\t\t},\r\n\t\t\treconnection: false, // IMPORTANTE: vamos controlar manualmente\r\n\t\t});\r\n\r\n\t\tthis.socket.on(\"connect\", () => {\r\n\t\t\t// ✅ ZERA falhas quando conecta\r\n\r\n\t\t\t// Só loga se antes estava em falha crítica\r\n\t\t\tif (this.failedAttempts >= this.MAX_FAIL_LOG) {\r\n\t\t\t\tconsole.log(\"✅ Socket.IO reconectado após tentativas! Nada mais a relatar. Ta tudo tranquilo!\");\r\n\t\t\t}\r\n\r\n\t\t\tthis.failedAttempts = 0;\r\n\t\t\t!isLogged && console.log(\"✅ Socket.IO connected!\");\r\n\t\t\tisLogged = true;\r\n\r\n\t\t\t// Cancela qualquer tentativa pendente\r\n\t\t\tif (this.reconnectTimer) {\r\n\t\t\t\tclearTimeout(this.reconnectTimer);\r\n\t\t\t\tthis.reconnectTimer = null;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tthis.socket.on(\"disconnect\", (reason) => {\r\n\t\t\tthis.failedAttempts++;\r\n\r\n\t\t\t// Só loga depois de 7 falhas seguidas\r\n\t\t\tif (this.failedAttempts >= this.MAX_FAIL_LOG) {\r\n\t\t\t\tconsole.log(`❌ Socket.IO disconnected ${this.failedAttempts}x seguidas:`, reason);\r\n\t\t\t}\r\n\r\n\t\t\tthis.scheduleReconnect();\r\n\t\t});\r\n\r\n\t\tthis.socket.on(\"connect_error\", (err) => {\r\n\t\t\tthis.failedAttempts++;\r\n\r\n\t\t\tif (this.failedAttempts >= this.MAX_FAIL_LOG) {\r\n\t\t\t\tconsole.log(`⚠️ Socket.IO connection error ${this.failedAttempts}x:`, err.message);\r\n\t\t\t}\r\n\r\n\t\t\tthis.scheduleReconnect();\r\n\t\t});\r\n\r\n\t\tthis.socket.onAny((event, payload) => {\r\n\t\t\tthis.messages$.next({ event, payload });\r\n\t\t});\r\n\t}\r\n\r\n\tprivate scheduleReconnect() {\r\n\t\tif (this.reconnectTimer) return; // já agendado\r\n\r\n\t\tthis.reconnectTimer = setTimeout(() => {\r\n\t\t\tthis.reconnectTimer = null;\r\n\t\t\tthis.connect();\r\n\t\t}, this.reconnectTimeout);\r\n\t}\r\n\r\n\tsend(event: string, payload: any) {\r\n\t\tif (this.socket && this.socket.connected) {\r\n\t\t\tthis.socket.emit(event, payload);\r\n\t\t}\r\n\t}\r\n\r\n\ton<T = any>(event: string): Observable<T> {\r\n\t\treturn new Observable<T>((subscriber) => {\r\n\t\t\tconst sub = this.messages$.subscribe((msg) => {\r\n\t\t\t\tif (msg.event === event) {\r\n\t\t\t\t\tsubscriber.next(msg.payload);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\treturn () => sub.unsubscribe();\r\n\t\t});\r\n\t}\r\n\r\n\tonModuleDestroy() {\r\n\t\tthis.socket?.disconnect();\r\n\t\tif (this.reconnectTimer) {\r\n\t\t\tclearTimeout(this.reconnectTimer);\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["WsClientService","isLogged","connect","socket","connected","io","url","transports","query","accessToken","dotEnv","API_TOKEN","connectionType","auth","token","reconnection","on","failedAttempts","MAX_FAIL_LOG","console","log","reconnectTimer","clearTimeout","reason","scheduleReconnect","err","message","onAny","event","payload","messages$","next","setTimeout","reconnectTimeout","send","emit","Observable","subscriber","sub","subscribe","msg","unsubscribe","onModuleDestroy","disconnect","NODE_ENV","Subject"],"mappings":"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"}