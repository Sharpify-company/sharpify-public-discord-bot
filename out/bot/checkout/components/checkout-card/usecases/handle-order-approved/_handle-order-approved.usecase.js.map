{"version":3,"sources":["../../../../../../../src/bot/checkout/components/checkout-card/usecases/handle-order-approved/_handle-order-approved.usecase.ts"],"sourcesContent":["import { getLocalStoreConfig, Sharpify } from \"@/@shared/sharpify\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChannelType,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tPermissionsBitField,\r\n} from \"discord.js\";\r\nimport { dotEnv } from \"@/@shared/lib\";\r\n\r\nimport { ValidateDatabaseCartItemsHelper } from \"@/bot/checkout/helpers\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport { DiscordUserEntity, OrderEntity } from \"@/@shared/db/entities\";\r\nimport { get } from \"http\";\r\nimport { GiveRoleToUserUsecase } from \"./give-role-to-user.usecase\";\r\nimport { SendPublicSalesLogUsecase } from \"./send-public-sales-log.usecase\";\r\nimport { SendPrivateSalesLogUsecase } from \"./send-private-sales-log.usecase\";\r\n\r\n@Injectable()\r\nexport class HandleOrderApprovedUsecase {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\tprivate readonly giveRoleToUserUsecase: GiveRoleToUserUsecase,\r\n\t\tprivate readonly sendPublicSalesLogUsecase: SendPublicSalesLogUsecase,\r\n\t\tprivate readonly sendPrivateSalesLogUsecase: SendPrivateSalesLogUsecase,\r\n\t) {}\r\n\r\n\tasync giveRoleToUser(input: GiveRoleToUserUsecase.Input) {\r\n\t\treturn this.giveRoleToUserUsecase.execute(input);\r\n\t}\r\n\r\n\tasync sendPublicSalesLog(input: SendPublicSalesLogUsecase.Input) {\r\n\t\treturn this.sendPublicSalesLogUsecase.execute(input);\r\n\t}\r\n\r\n\tasync sendPrivateSalesLog(input: SendPrivateSalesLogUsecase.Input) {\r\n\t\treturn this.sendPrivateSalesLogUsecase.execute(input);\r\n\t}\r\n\r\n\tasync execute({ orderId }: { orderId: string }) {\r\n\t\tconst orderEntity = await OrderEntity.findOneBy({ id: orderId });\r\n\t\tif (!orderEntity) return;\r\n\t\tif (orderEntity.deliveryStatus !== \"PENDING\") return;\r\n\r\n\t\tconst discordUser = await DiscordUserEntity.findOneBy({ id: orderEntity.customerId });\r\n\t\tif (!discordUser) return;\r\n\r\n\t\tconst orderChannel = await this.client.channels.fetch(discordUser.cart.channelId!).catch(() => null);\r\n\t\torderChannel && (await orderChannel.delete().catch(() => null));\r\n\r\n\t\tawait orderEntity.markAsPreparingDelivery();\r\n\t\tawait discordUser.cart.cancelOrder();\r\n\t\tawait this.giveRoleToUser({ discordUserId: discordUser.id });\r\n\t\tawait this.sendPublicSalesLog({ discordUserId: discordUser.id, orderProps: orderEntity.orderProps });\r\n\t\tawait this.sendPrivateSalesLog({ discordUserId: discordUser.id, orderProps: orderEntity.orderProps });\r\n\t}\r\n}\r\n"],"names":["HandleOrderApprovedUsecase","giveRoleToUser","input","giveRoleToUserUsecase","execute","sendPublicSalesLog","sendPublicSalesLogUsecase","sendPrivateSalesLog","sendPrivateSalesLogUsecase","orderId","orderEntity","OrderEntity","findOneBy","id","deliveryStatus","discordUser","DiscordUserEntity","customerId","orderChannel","client","channels","fetch","cart","channelId","catch","delete","markAsPreparingDelivery","cancelOrder","discordUserId","orderProps"],"mappings":";;;;+BAuBaA;;;eAAAA;;;yBAZN;wBAI4B;0BACY;uCAET;2CACI;4CACC;;;;;;;;;;;;;;;AAGpC,IAAA,AAAMA,6BAAN,MAAMA;IAQZ,MAAMC,eAAeC,KAAkC,EAAE;QACxD,OAAO,IAAI,CAACC,qBAAqB,CAACC,OAAO,CAACF;IAC3C;IAEA,MAAMG,mBAAmBH,KAAsC,EAAE;QAChE,OAAO,IAAI,CAACI,yBAAyB,CAACF,OAAO,CAACF;IAC/C;IAEA,MAAMK,oBAAoBL,KAAuC,EAAE;QAClE,OAAO,IAAI,CAACM,0BAA0B,CAACJ,OAAO,CAACF;IAChD;IAEA,MAAME,QAAQ,EAAEK,OAAO,EAAuB,EAAE;QAC/C,MAAMC,cAAc,MAAMC,qBAAW,CAACC,SAAS,CAAC;YAAEC,IAAIJ;QAAQ;QAC9D,IAAI,CAACC,aAAa;QAClB,IAAIA,YAAYI,cAAc,KAAK,WAAW;QAE9C,MAAMC,cAAc,MAAMC,2BAAiB,CAACJ,SAAS,CAAC;YAAEC,IAAIH,YAAYO,UAAU;QAAC;QACnF,IAAI,CAACF,aAAa;QAElB,MAAMG,eAAe,MAAM,IAAI,CAACC,MAAM,CAACC,QAAQ,CAACC,KAAK,CAACN,YAAYO,IAAI,CAACC,SAAS,EAAGC,KAAK,CAAC,IAAM;QAC/FN,gBAAiB,MAAMA,aAAaO,MAAM,GAAGD,KAAK,CAAC,IAAM;QAEzD,MAAMd,YAAYgB,uBAAuB;QACzC,MAAMX,YAAYO,IAAI,CAACK,WAAW;QAClC,MAAM,IAAI,CAAC1B,cAAc,CAAC;YAAE2B,eAAeb,YAAYF,EAAE;QAAC;QAC1D,MAAM,IAAI,CAACR,kBAAkB,CAAC;YAAEuB,eAAeb,YAAYF,EAAE;YAAEgB,YAAYnB,YAAYmB,UAAU;QAAC;QAClG,MAAM,IAAI,CAACtB,mBAAmB,CAAC;YAAEqB,eAAeb,YAAYF,EAAE;YAAEgB,YAAYnB,YAAYmB,UAAU;QAAC;IACpG;IAnCA,YACC,AAAiCV,MAAc,EAC/C,AAAiBhB,qBAA4C,EAC7D,AAAiBG,yBAAoD,EACrE,AAAiBE,0BAAsD,CACtE;aAJgCW,SAAAA;aAChBhB,wBAAAA;aACAG,4BAAAA;aACAE,6BAAAA;IACf;AA+BJ"}