{"version":3,"sources":["../../../../../src/bot/products/commands/delivery-products/delivery-products.command.ts"],"sourcesContent":["import { Injectable, Logger, UseInterceptors } from \"@nestjs/common\";\r\nimport { AttachmentBuilder, EmbedBuilder, Integration, User } from \"discord.js\";\r\nimport { Context, Options, SlashCommand, SlashCommandContext, StringOption, UserOption, NumberOption } from \"necord\";\r\nimport { ProductAutocompleteInterceptor } from \"./auto-complete-product.interceptor\";\r\nimport { Sharpify } from \"@/@shared/sharpify\";\r\nimport { BotConfig } from \"@/config\";\r\nimport TurndownService from \"turndown\";\r\nimport { formatPrice } from \"@/@shared/lib\";\r\nimport { FindEmojiHelper } from \"@/@shared/helpers\";\r\n\r\nconst turndownService = new TurndownService();\r\n\r\nexport class InputDto {\r\n\t@StringOption({\r\n\t\tname: \"titulo\",\r\n\t\tdescription: \"T√≠tulo do produto\",\r\n\t\trequired: true,\r\n\t\tmax_length: 100,\r\n\t\tautocomplete: true,\r\n\t})\r\n\tproductIdAndItemId!: string;\r\n\r\n\t@UserOption({\r\n\t\tname: \"usuario\",\r\n\t\tdescription: \"Usu√°rio que receber√° o produto\",\r\n\t\trequired: true,\r\n\t})\r\n\tuser!: User;\r\n\r\n\t@NumberOption({\r\n\t\tname: \"quantidade\",\r\n\t\tdescription: \"Quantidade de produtos a serem entregues\",\r\n\t\trequired: true,\r\n\t\tmin_value: 1,\r\n\t\tmax_value: 100,\r\n\t})\r\n\tquantity!: number;\r\n}\r\n\r\n@Injectable()\r\nexport class ListProductsCommand {\r\n\tconstructor() {}\r\n\r\n\t@UseInterceptors(ProductAutocompleteInterceptor)\r\n\t@SlashCommand({\r\n\t\tname: \"entregar-produto\",\r\n\t\tdescription: \"[üì¶] Entregue um produto sem a necessidade de uma compra.\",\r\n\t\tdefaultMemberPermissions: [\"Administrator\"],\r\n\t})\r\n\tpublic async onListProducts(\r\n\t\t@Context() [interaction]: SlashCommandContext,\r\n\t\t@Options() { productIdAndItemId, user, quantity }: InputDto,\r\n\t) {\r\n\t\tconst [productId, productItemId] = productIdAndItemId.split(\":\");\r\n\r\n\t\tconst productReq = await Sharpify.api.v1.catalog.product.get({\r\n\t\t\tid: productId,\r\n\t\t\tincludeNonListed: true,\r\n\t\t});\r\n\r\n\t\tif (!productReq.success) {\r\n\t\t\treturn interaction.reply({\r\n\t\t\t\tcontent: `Error ao buscar produto: ${productReq.errorName}`,\r\n\t\t\t\tflags: [\"Ephemeral\"],\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tawait interaction.deferReply({ flags: [\"Ephemeral\"] });\r\n\r\n\t\tconst StockReq = await Sharpify.api.v1.catalog.product.decreseStock({\r\n\t\t\tproductId,\r\n\t\t\tproductItemId,\r\n\t\t\tquantity,\r\n\t\t});\r\n\r\n\t\tif (!StockReq.success) {\r\n\t\t\tlet errorMessage = StockReq.errorName;\r\n\t\t\tif (StockReq.errorName === \"InsufficientStockError\") {\r\n\t\t\t\terrorMessage = `Estoque insuficiente para entregar ${quantity} unidade(s) deste produto.`;\r\n\t\t\t}\r\n\t\t\treturn interaction.editReply({\r\n\t\t\t\tcontent: `Error ao buscar produto: ${errorMessage}`,\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst staticStock = StockReq.data.type === \"STATIC\" ? StockReq.data.stock : \"Sem stoque\";\r\n\t\tconst lineStocks = StockReq.data.type === \"LINES\" ? JSON.parse(StockReq.data.stock || \"[]\") : [];\r\n\r\n\t\tconst boxIcon = await FindEmojiHelper({ client: interaction.client, name: \"Sharpify_caixa\" });\r\n\t\tconst cartIcon = await FindEmojiHelper({ client: interaction.client, name: \"Sharpify_carrinho\" });\r\n\r\n\t\tconst product = productReq.data.product;\r\n\t\tconst productEmbed = new EmbedBuilder()\r\n\t\t\t.setTitle(`${boxIcon} **Produto entregue por um administrador!**`)\r\n\t\t\t.setDescription(`üéâ Voc√™ recebeu alguns produtos do admistrador ${interaction.user}`)\r\n\t\t\t.setColor(BotConfig.color)\r\n\t\t\t.addFields({\r\n\t\t\t\tname: `${boxIcon} Produto:`,\r\n\t\t\t\tvalue: `\\`\\`${product.settings.viewType === \"NORMAL\" ? product.info.title : `${product.info.title} -> ${product.dynamicItems.find((item) => item.id === productItemId)?.info.title || \"Sem nome\"}`}\\`\\``,\r\n\t\t\t\tinline: true,\r\n\t\t\t})\r\n\t\t\t.addFields({\r\n\t\t\t\tname: `${cartIcon} Quantidade:`,\r\n\t\t\t\tvalue: `\\`\\`${quantity} unidades\\`\\``,\r\n\t\t\t\tinline: true,\r\n\t\t\t});\r\n\r\n\t\tconst deliveryEmbed = new EmbedBuilder()\r\n\t\t\t.setTitle(`${boxIcon} **Entrega do produto: ${quantity} de ${quantity}**`)\r\n\t\t\t.setColor(BotConfig.color);\r\n\r\n\t\tlet fileAttachment: AttachmentBuilder | null = null;\r\n\r\n\t\tif (StockReq.data.type === \"STATIC\") {\r\n\t\t\tif (staticStock.length > 1024) {\r\n\t\t\t\t// cria um arquivo tempor√°rio com o conte√∫do do estoque\r\n\t\t\t\tconst fileContent = `Estoque:\\n${staticStock}`;\r\n\t\t\t\tfileAttachment = new AttachmentBuilder(Buffer.from(fileContent), {\r\n\t\t\t\t\tname: \"estoque.txt\",\r\n\t\t\t\t});\r\n\t\t\t\tdeliveryEmbed.addFields({\r\n\t\t\t\t\tname: \"Estoque:\",\r\n\t\t\t\t\tvalue: \"üìÑ Estoque muito grande ‚Äî veja o arquivo `estoque.txt` em anexo.\",\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tdeliveryEmbed.addFields({ name: `Estoque:`, value: `\\`\\`${staticStock}\\`\\`` });\r\n\t\t\t}\r\n\t\t} else if (StockReq.data.type === \"LINES\") {\r\n\t\t\tconst joined = lineStocks.map((lineStock: string) => `\\`\\`${lineStock}\\`\\``).join(\"\\n\");\r\n\t\t\tif (joined.length > 1024) {\r\n\t\t\t\tconst fileContent = `Estoques:\\n${joined}`;\r\n\t\t\t\tfileAttachment = new AttachmentBuilder(Buffer.from(fileContent), {\r\n\t\t\t\t\tname: \"estoques.txt\",\r\n\t\t\t\t});\r\n\t\t\t\tdeliveryEmbed.addFields({\r\n\t\t\t\t\tname: \"Estoques:\",\r\n\t\t\t\t\tvalue: \"üìÑ Lista muito grande ‚Äî veja o arquivo `estoques.txt` em anexo.\",\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tdeliveryEmbed.addFields({ name: \"Estoques:\", value: joined });\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconst dm = await user.createDM().catch(() => null);\r\n\t\t\tawait dm?.send({\r\n\t\t\t\tcontent: `Ol√° ${user}! üëã\\nUm administrador entregou estoque para voc√™!`,\r\n\t\t\t\tembeds: [productEmbed, deliveryEmbed],\r\n\t\t\t\tfiles: fileAttachment ? [fileAttachment] : [],\r\n\t\t\t});\r\n\t\t\treturn interaction.editReply({\r\n\t\t\t\tcontent: `Estoque entregue com sucesso para o usu√°rio ${user}. \\n Veja a mensagem enviada:`,\r\n\t\t\t\tembeds: [productEmbed, deliveryEmbed],\r\n\t\t\t\tcomponents: [],\r\n\t\t\t\tfiles: fileAttachment ? [fileAttachment] : [],\r\n\t\t\t});\r\n\t\t} catch (error) {\r\n\t\t\treturn interaction.editReply({\r\n\t\t\t\tcontent: `Estoque foi removido do estoque. Mas n√£o foi poss√≠vel enviar a mensagem direta ao usu√°rio. `,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["InputDto","ListProductsCommand","turndownService","TurndownService","name","description","required","max_length","autocomplete","min_value","max_value","onListProducts","interaction","productIdAndItemId","user","quantity","productId","productItemId","split","productReq","Sharpify","api","v1","catalog","product","get","id","includeNonListed","success","reply","content","errorName","flags","deferReply","StockReq","decreseStock","errorMessage","editReply","staticStock","data","type","stock","lineStocks","JSON","parse","boxIcon","FindEmojiHelper","client","cartIcon","productEmbed","EmbedBuilder","setTitle","setDescription","setColor","BotConfig","color","addFields","value","settings","viewType","info","title","dynamicItems","find","item","inline","deliveryEmbed","fileAttachment","length","fileContent","AttachmentBuilder","Buffer","from","joined","map","lineStock","join","dm","createDM","catch","send","embeds","files","components","error","defaultMemberPermissions"],"mappings":"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"}