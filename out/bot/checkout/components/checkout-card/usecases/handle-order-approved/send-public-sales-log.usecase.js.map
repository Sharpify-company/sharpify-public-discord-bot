{"version":3,"sources":["../../../../../../../src/bot/checkout/components/checkout-card/usecases/handle-order-approved/send-public-sales-log.usecase.ts"],"sourcesContent":["import { getLocalStoreConfig, Sharpify } from \"@/@shared/sharpify\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChannelType,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tGuildMember,\r\n\tPermissionsBitField,\r\n\tTextChannel,\r\n} from \"discord.js\";\r\nimport { dotEnv, formatPrice } from \"@/@shared/lib\";\r\n\r\nimport { ValidateDatabaseCartItemsHelper } from \"@/bot/checkout/helpers\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport { DiscordUserEntity, OrderEntity } from \"@/@shared/db/entities\";\r\nimport { get } from \"http\";\r\nimport { BotConfig } from \"@/config\";\r\nimport { OrderProps } from \"@/@shared/sharpify/api\";\r\n\r\nconst sentMessages = new Set<string>();\r\n\r\n@Injectable()\r\nexport class SendPublicSalesLogUsecase {\r\n\tconstructor(@Inject(Client) private readonly client: Client) {}\r\n\r\n\tasync execute({ discordUserId, orderProps }: SendPublicSalesLogUsecase.Input) {\r\n\t\tif (sentMessages.has(orderProps.shortReference)) return;\r\n\r\n\t\tconst storePreferences = (await getLocalStoreConfig()).getPreferences();\r\n\t\tif (!storePreferences.publicLogSales.enabled) return;\r\n\r\n\t\tconst guild = await this.client.guilds.fetch(process.env.DISCORD_GUILD_ID!).catch(() => null);\r\n\t\tif (!guild) return;\r\n\r\n\t\tlet member: GuildMember | null = null;\r\n\r\n\t\tmember = discordUserId ? await guild.members.fetch(discordUserId).catch(() => null) : null;\r\n\t\tif (storePreferences.publicLogSales.onlyDiscordSales && !member) return;\r\n\r\n\t\tconst channel = (await guild.channels.fetch(storePreferences.publicLogSales.channelId!).catch(() => null)) as TextChannel;\r\n\t\tif (!channel || channel.type !== ChannelType.GuildText) return;\r\n\r\n\t\tconst embed = new EmbedBuilder()\r\n\t\t\t.setColor(BotConfig.color)\r\n\t\t\t.setTitle(\"ðŸ›’ Nova compra feita.\")\r\n\t\t\t.setDescription(`Compra feito com successo e com seguranÃ§a.`);\r\n\r\n\t\tembed.addFields([\r\n\t\t\t{\r\n\t\t\t\tname: \"`ðŸ†”` ID do pedido:\",\r\n\t\t\t\tvalue: `\\`\\`\\`#${orderProps.shortReference}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"`ðŸ“¦` Produtos comprado:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${orderProps.orderItems.map((item) => `ãƒ» ${item.product.backup.title}${item.product.backup.viewType === \"DYNAMIC\" ? ` > ${item.product.itemBackup?.title}` : \"\"} (${item.quantity}x)`).join(\"\\n\")}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t]);\r\n\r\n\t\tembed.addFields([\r\n\t\t\t{\r\n\t\t\t\tname: \"`ðŸ“…` Pedido feito em:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${new Date(orderProps.createdAt).toLocaleString(\"pt-br\")}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"`ðŸ’¸` Valor total:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${formatPrice(orderProps.pricing.total)}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t]);\r\n\r\n\t\tif (member) {\r\n\t\t\tembed.addFields([\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"`ðŸ‘¤` Comprador:\",\r\n\t\t\t\t\tvalue: `Muito obrigado  ${member} por comprar em nossa loja!`,\r\n\t\t\t\t},\r\n\t\t\t]);\r\n\t\t}\r\n\r\n\t\tawait channel.send({ embeds: [embed] }).catch((err) => console.log(err));\r\n\t\tsentMessages.add(orderProps.shortReference);\r\n\t}\r\n}\r\n\r\nexport namespace SendPublicSalesLogUsecase {\r\n\texport interface Input {\r\n\t\tdiscordUserId?: string;\r\n\t\torderProps: OrderProps;\r\n\t}\r\n}\r\n"],"names":["SendPublicSalesLogUsecase","sentMessages","Set","execute","discordUserId","orderProps","has","shortReference","storePreferences","getLocalStoreConfig","getPreferences","publicLogSales","enabled","guild","client","guilds","fetch","process","env","DISCORD_GUILD_ID","catch","member","members","onlyDiscordSales","channel","channels","channelId","type","ChannelType","GuildText","embed","EmbedBuilder","setColor","BotConfig","color","setTitle","setDescription","addFields","name","value","orderItems","map","item","product","backup","title","viewType","itemBackup","quantity","join","Date","createdAt","toLocaleString","formatPrice","pricing","total","send","embeds","err","console","log","add"],"mappings":";;;;+BA0BaA;;;eAAAA;;;0BA1BiC;yBAavC;qBAC6B;wBAGD;wBAGT;;;;;;;;;;;;;;;AAG1B,MAAMC,eAAe,IAAIC;AAGlB,IAAA,AAAMF,4BAAN,MAAMA;IAGZ,MAAMG,QAAQ,EAAEC,aAAa,EAAEC,UAAU,EAAmC,EAAE;QAC7E,IAAIJ,aAAaK,GAAG,CAACD,WAAWE,cAAc,GAAG;QAEjD,MAAMC,mBAAmB,AAAC,CAAA,MAAMC,IAAAA,6BAAmB,GAAC,EAAGC,cAAc;QACrE,IAAI,CAACF,iBAAiBG,cAAc,CAACC,OAAO,EAAE;QAE9C,MAAMC,QAAQ,MAAM,IAAI,CAACC,MAAM,CAACC,MAAM,CAACC,KAAK,CAACC,QAAQC,GAAG,CAACC,gBAAgB,EAAGC,KAAK,CAAC,IAAM;QACxF,IAAI,CAACP,OAAO;QAEZ,IAAIQ,SAA6B;QAEjCA,SAASjB,gBAAgB,MAAMS,MAAMS,OAAO,CAACN,KAAK,CAACZ,eAAegB,KAAK,CAAC,IAAM,QAAQ;QACtF,IAAIZ,iBAAiBG,cAAc,CAACY,gBAAgB,IAAI,CAACF,QAAQ;QAEjE,MAAMG,UAAW,MAAMX,MAAMY,QAAQ,CAACT,KAAK,CAACR,iBAAiBG,cAAc,CAACe,SAAS,EAAGN,KAAK,CAAC,IAAM;QACpG,IAAI,CAACI,WAAWA,QAAQG,IAAI,KAAKC,oBAAW,CAACC,SAAS,EAAE;QAExD,MAAMC,QAAQ,IAAIC,qBAAY,GAC5BC,QAAQ,CAACC,iBAAS,CAACC,KAAK,EACxBC,QAAQ,CAAC,yBACTC,cAAc,CAAC,CAAC,0CAA0C,CAAC;QAE7DN,MAAMO,SAAS,CAAC;YACf;gBACCC,MAAM;gBACNC,OAAO,CAAC,OAAO,EAAElC,WAAWE,cAAc,CAAC,MAAM,CAAC;YACnD;YACA;gBACC+B,MAAM;gBACNC,OAAO,CAAC,MAAM,EAAElC,WAAWmC,UAAU,CAACC,GAAG,CAAC,CAACC,OAAS,CAAC,EAAE,EAAEA,KAAKC,OAAO,CAACC,MAAM,CAACC,KAAK,GAAGH,KAAKC,OAAO,CAACC,MAAM,CAACE,QAAQ,KAAK,YAAY,CAAC,GAAG,EAAEJ,KAAKC,OAAO,CAACI,UAAU,EAAEF,OAAO,GAAG,GAAG,EAAE,EAAEH,KAAKM,QAAQ,CAAC,EAAE,CAAC,EAAEC,IAAI,CAAC,MAAM,MAAM,CAAC;YACxN;SACA;QAEDnB,MAAMO,SAAS,CAAC;YACf;gBACCC,MAAM;gBACNC,OAAO,CAAC,MAAM,EAAE,IAAIW,KAAK7C,WAAW8C,SAAS,EAAEC,cAAc,CAAC,SAAS,MAAM,CAAC;YAC/E;YACA;gBACCd,MAAM;gBACNC,OAAO,CAAC,MAAM,EAAEc,IAAAA,gBAAW,EAAChD,WAAWiD,OAAO,CAACC,KAAK,EAAE,MAAM,CAAC;YAC9D;SACA;QAED,IAAIlC,QAAQ;YACXS,MAAMO,SAAS,CAAC;gBACf;oBACCC,MAAM;oBACNC,OAAO,CAAC,gBAAgB,EAAElB,OAAO,2BAA2B,CAAC;gBAC9D;aACA;QACF;QAEA,MAAMG,QAAQgC,IAAI,CAAC;YAAEC,QAAQ;gBAAC3B;aAAM;QAAC,GAAGV,KAAK,CAAC,CAACsC,MAAQC,QAAQC,GAAG,CAACF;QACnEzD,aAAa4D,GAAG,CAACxD,WAAWE,cAAc;IAC3C;IAzDA,YAAY,AAAiCO,MAAc,CAAE;aAAhBA,SAAAA;IAAiB;AA0D/D"}