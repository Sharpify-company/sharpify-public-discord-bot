{"version":3,"sources":["../../../src/workers/usecases/handle-feedback-event.ts"],"sourcesContent":["import { ExternalEventsEntity, OrderEntity } from \"@/@shared/db/entities\";\r\nimport { getLocalStoreConfig } from \"@/@shared/sharpify\";\r\nimport { OrderProps, ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { ProductCardComponent } from \"@/bot/checkout/components\";\r\nimport { HandleOrderApprovedUsecase, HandleOrderCancelledUsecase } from \"@/bot/checkout/components/checkout-card/usecases\";\r\nimport { HandleOrderFeedbackSentUsecase } from \"@/bot/checkout/components/checkout-card/usecases/handle-order-feedback-sent/_handle-order-feedback-sent.usecase\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport { Client, TextChannel } from \"discord.js\";\r\nimport {} from \"necord\";\r\n\r\n@Injectable()\r\nexport class HandleFeedbackEvent {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\tprivate readonly handleOrderFeedbackSentUsecase: HandleOrderFeedbackSentUsecase,\r\n\t) {}\r\n\r\n\tasync create(externalEventEntity: ExternalEventsEntity) {\r\n\t\tconst payloadOrder: OrderProps = externalEventEntity.payload as OrderProps;\r\n\t\tconst orderEntity = await OrderEntity.findOneBy({ id: externalEventEntity.contextAggregateId });\r\n\t\tif (!orderEntity) {\r\n\t\t\tawait this.handleOrderFeedbackSentUsecase.sendPrivateLog({\r\n\t\t\t\torder: payloadOrder,\r\n\t\t\t\tdiscordUserId: payloadOrder.customer?.info?.platform.discordId,\r\n\t\t\t});\r\n\r\n\t\t\tawait this.handleOrderFeedbackSentUsecase.sendPublicLog({\r\n\t\t\t\torder: payloadOrder,\r\n\t\t\t\tdiscordUserId: payloadOrder.customer?.info?.platform.discordId,\r\n\t\t\t});\r\n\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (externalEventEntity.eventName === \"ORDER_FEEDBACK_RECEIVED\") {\r\n\t\t\tawait orderEntity.updateOrderProps(payloadOrder);\r\n\t\t\tawait this.handleOrderFeedbackSentUsecase.sendPrivateLog({\r\n\t\t\t\torder: orderEntity.orderProps,\r\n\t\t\t\tdiscordUserId: orderEntity.customerId,\r\n\t\t\t});\r\n\t\t\tawait this.handleOrderFeedbackSentUsecase.sendPublicLog({\r\n\t\t\t\torder: orderEntity.orderProps,\r\n\t\t\t\tdiscordUserId: orderEntity.customerId,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["HandleFeedbackEvent","create","externalEventEntity","payloadOrder","payload","orderEntity","OrderEntity","findOneBy","id","contextAggregateId","handleOrderFeedbackSentUsecase","sendPrivateLog","order","discordUserId","customer","info","platform","discordId","sendPublicLog","eventName","updateOrderProps","orderProps","customerId","client"],"mappings":";;;;+BAWaA;;;eAAAA;;;0BAXqC;gDAKH;wBACZ;yBACC;QACrB;;;;;;;;;;;;;;;AAGR,IAAA,AAAMA,sBAAN,MAAMA;IAMZ,MAAMC,OAAOC,mBAAyC,EAAE;QACvD,MAAMC,eAA2BD,oBAAoBE,OAAO;QAC5D,MAAMC,cAAc,MAAMC,qBAAW,CAACC,SAAS,CAAC;YAAEC,IAAIN,oBAAoBO,kBAAkB;QAAC;QAC7F,IAAI,CAACJ,aAAa;YACjB,MAAM,IAAI,CAACK,8BAA8B,CAACC,cAAc,CAAC;gBACxDC,OAAOT;gBACPU,eAAeV,aAAaW,QAAQ,EAAEC,MAAMC,SAASC;YACtD;YAEA,MAAM,IAAI,CAACP,8BAA8B,CAACQ,aAAa,CAAC;gBACvDN,OAAOT;gBACPU,eAAeV,aAAaW,QAAQ,EAAEC,MAAMC,SAASC;YACtD;YAEA;QACD;QAEA,IAAIf,oBAAoBiB,SAAS,KAAK,2BAA2B;YAChE,MAAMd,YAAYe,gBAAgB,CAACjB;YACnC,MAAM,IAAI,CAACO,8BAA8B,CAACC,cAAc,CAAC;gBACxDC,OAAOP,YAAYgB,UAAU;gBAC7BR,eAAeR,YAAYiB,UAAU;YACtC;YACA,MAAM,IAAI,CAACZ,8BAA8B,CAACQ,aAAa,CAAC;gBACvDN,OAAOP,YAAYgB,UAAU;gBAC7BR,eAAeR,YAAYiB,UAAU;YACtC;QACD;IACD;IAjCA,YACC,AAAiCC,MAAc,EAC/C,AAAiBb,8BAA8D,CAC9E;aAFgCa,SAAAA;aAChBb,iCAAAA;IACf;AA+BJ"}