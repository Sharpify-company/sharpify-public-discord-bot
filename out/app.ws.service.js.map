{"version":3,"sources":["../src/app.ws.service.ts"],"sourcesContent":["// ws-client.service.ts\r\nimport { Injectable, OnModuleDestroy } from \"@nestjs/common\";\r\nimport { io, Socket } from \"socket.io-client\";\r\nimport { Subject, Observable } from \"rxjs\";\r\nimport { dotEnv } from \"./@shared/lib\";\r\n\r\n@Injectable()\r\nexport class WsClientService implements OnModuleDestroy {\r\n\tprivate socket: Socket | null = null;\r\n\tprivate reconnectTimeout = 3000; // 3 seconds\r\n\tprivate url = dotEnv.NODE_ENV === \"development\" ? \"http://localhost:1000\" : \"https://ws.sharpify.com.br\";\r\n\r\n\tprivate messages$ = new Subject<any>();\r\n\r\n\tconstructor() {\r\n\t\tthis.connect();\r\n\t}\r\n\r\n\tprivate connect() {\r\n\t\tconsole.log(\"Connecting to WS:\", this.url);\r\n\r\n\t\tthis.socket = io(this.url, {\r\n\t\t\ttransports: [\"websocket\"],\r\n\t\t\tquery: {\r\n\t\t\t\taccessToken: dotEnv.API_TOKEN,\r\n\t\t\t\tconnectionType: \"STORE\",\r\n\t\t\t},\r\n\t\t\tauth: {\r\n\t\t\t\ttoken: dotEnv.API_TOKEN,\r\n\t\t\t\tconnectionType: \"STORE\",\r\n\t\t\t},\r\n\t\t\treconnectionAttempts: Infinity,\r\n\t\t\treconnectionDelay: this.reconnectTimeout,\r\n\t\t});\r\n\r\n\t\tthis.socket.on(\"connect\", () => {\r\n\t\t\tconsole.log(\"✅ Socket.IO connected!\");\r\n\t\t});\r\n\r\n\t\tthis.socket.on(\"disconnect\", (reason) => {\r\n\t\t\tconsole.log(\"❌ Socket.IO disconnected:\", reason);\r\n\t\t\tsetTimeout(() => this.connect(), 5000);\r\n\t\t});\r\n\r\n\t\tthis.socket.on(\"connect_error\", (err) => {\r\n\t\t\tconsole.log(\"Socket.IO connection error:\", err.message);\r\n\t\t});\r\n\r\n\t\tthis.socket.onAny((event, payload) => {\r\n\t\t\tthis.messages$.next({ event, payload });\r\n\t\t});\r\n\t}\r\n\r\n\tsend(event: string, payload: any) {\r\n\t\tif (this.socket && this.socket.connected) {\r\n\t\t\tthis.socket.emit(event, payload);\r\n\t\t}\r\n\t}\r\n\r\n\ton<T = any>(event: string): Observable<T> {\r\n\t\treturn new Observable<T>((subscriber) => {\r\n\t\t\tconst sub = this.messages$.subscribe((msg) => {\r\n\t\t\t\tif (msg.event === event) {\r\n\t\t\t\t\tsubscriber.next(msg.payload);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\treturn () => sub.unsubscribe();\r\n\t\t});\r\n\t}\r\n\r\n\tonModuleDestroy() {\r\n\t\tthis.socket?.disconnect();\r\n\t}\r\n}\r\n"],"names":["WsClientService","connect","console","log","url","socket","io","transports","query","accessToken","dotEnv","API_TOKEN","connectionType","auth","token","reconnectionAttempts","Infinity","reconnectionDelay","reconnectTimeout","on","reason","setTimeout","err","message","onAny","event","payload","messages$","next","send","connected","emit","Observable","subscriber","sub","subscribe","msg","unsubscribe","onModuleDestroy","disconnect","NODE_ENV","Subject"],"mappings":"AAAA,uBAAuB;;;;;+BAOVA;;;eAAAA;;;wBAN+B;gCACjB;sBACS;qBACb;;;;;;;;;;AAGhB,IAAA,AAAMA,kBAAN,MAAMA;IAWJC,UAAU;QACjBC,QAAQC,GAAG,CAAC,qBAAqB,IAAI,CAACC,GAAG;QAEzC,IAAI,CAACC,MAAM,GAAGC,IAAAA,kBAAE,EAAC,IAAI,CAACF,GAAG,EAAE;YAC1BG,YAAY;gBAAC;aAAY;YACzBC,OAAO;gBACNC,aAAaC,WAAM,CAACC,SAAS;gBAC7BC,gBAAgB;YACjB;YACAC,MAAM;gBACLC,OAAOJ,WAAM,CAACC,SAAS;gBACvBC,gBAAgB;YACjB;YACAG,sBAAsBC;YACtBC,mBAAmB,IAAI,CAACC,gBAAgB;QACzC;QAEA,IAAI,CAACb,MAAM,CAACc,EAAE,CAAC,WAAW;YACzBjB,QAAQC,GAAG,CAAC;QACb;QAEA,IAAI,CAACE,MAAM,CAACc,EAAE,CAAC,cAAc,CAACC;YAC7BlB,QAAQC,GAAG,CAAC,6BAA6BiB;YACzCC,WAAW,IAAM,IAAI,CAACpB,OAAO,IAAI;QAClC;QAEA,IAAI,CAACI,MAAM,CAACc,EAAE,CAAC,iBAAiB,CAACG;YAChCpB,QAAQC,GAAG,CAAC,+BAA+BmB,IAAIC,OAAO;QACvD;QAEA,IAAI,CAAClB,MAAM,CAACmB,KAAK,CAAC,CAACC,OAAOC;YACzB,IAAI,CAACC,SAAS,CAACC,IAAI,CAAC;gBAAEH;gBAAOC;YAAQ;QACtC;IACD;IAEAG,KAAKJ,KAAa,EAAEC,OAAY,EAAE;QACjC,IAAI,IAAI,CAACrB,MAAM,IAAI,IAAI,CAACA,MAAM,CAACyB,SAAS,EAAE;YACzC,IAAI,CAACzB,MAAM,CAAC0B,IAAI,CAACN,OAAOC;QACzB;IACD;IAEAP,GAAYM,KAAa,EAAiB;QACzC,OAAO,IAAIO,gBAAU,CAAI,CAACC;YACzB,MAAMC,MAAM,IAAI,CAACP,SAAS,CAACQ,SAAS,CAAC,CAACC;gBACrC,IAAIA,IAAIX,KAAK,KAAKA,OAAO;oBACxBQ,WAAWL,IAAI,CAACQ,IAAIV,OAAO;gBAC5B;YACD;YAEA,OAAO,IAAMQ,IAAIG,WAAW;QAC7B;IACD;IAEAC,kBAAkB;QACjB,IAAI,CAACjC,MAAM,EAAEkC;IACd;IA3DA,aAAc;aANNlC,SAAwB;aACxBa,mBAAmB,MAAM,YAAY;aACrCd,MAAMM,WAAM,CAAC8B,QAAQ,KAAK,gBAAgB,0BAA0B;aAEpEb,YAAY,IAAIc,aAAO;QAG9B,IAAI,CAACxC,OAAO;IACb;AA0DD"}