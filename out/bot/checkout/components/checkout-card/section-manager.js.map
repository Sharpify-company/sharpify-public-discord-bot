{"version":3,"sources":["../../../../../src/bot/checkout/components/checkout-card/section-manager.ts"],"sourcesContent":["import { Inject, Injectable } from \"@nestjs/common\";\r\nimport { Modal, Context, SlashCommand, SlashCommandContext, Ctx, ModalContext } from \"necord\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tAttachmentBuilder,\r\n\tButtonBuilder,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChatInputCommandInteraction,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tMessage,\r\n\tMessageCreateOptions,\r\n\tMessagePayload,\r\n\tModalActionRowComponentBuilder,\r\n\tModalBuilder,\r\n\tModalSubmitInteraction,\r\n\tTextChannel,\r\n\tTextInputBuilder,\r\n\tTextInputStyle,\r\n} from \"discord.js\";\r\nimport { BotConfig } from \"@/config\";\r\nimport { ProductProps } from \"@/@shared/sharpify/api\";\r\nimport { formatPrice } from \"@/@shared/lib\";\r\nimport TurndownService from \"turndown\";\r\nimport { DiscordUserEntity, OrderEntity, ProductEntity } from \"@/@shared/db/entities\";\r\nimport { CartEmmbedComponent } from \"./components/cart-emmbed\";\r\nimport { SelectCartItemComponent } from \"./components/select-cart-item\";\r\nimport { GoBackToMainSectionButionComponent } from \"./components/go-back-to-main-section-button\";\r\nimport { RemoveFromCartButtonComponent } from \"./components/remove-from-cart-button\";\r\nimport { UpdateQuantityButtonComponent } from \"./components/update-quantity-button\";\r\nimport { CancelOrderButtonComponent } from \"./components/cancell-order-button\";\r\nimport { ApplyCouponButtonComponent } from \"./components/apply-coupon-button\";\r\nimport { PlaceOrderButtonComponent } from \"./components/place-order-button\";\r\nimport { SelectPaymentMethodComponent } from \"./components/select-payment-method\";\r\nimport { ViewOnWebsiteButtonComponent } from \"./components/view-on-website\";\r\nimport { OpenDmTutorialButtonComponent } from \"./components/open-dm-tutorial-button\";\r\nimport { FindEmojiHelper } from \"@/@shared/helpers\";\r\n\r\ntype SetSectionProps = {\r\n\tdiscordUserId: string;\r\n} & (\r\n\t| {\r\n\t\t\tsection: \"MAIN\";\r\n\t  }\r\n\t| {\r\n\t\t\tsection: \"CART_ITEM\";\r\n\t\t\tproductId: string;\r\n\t\t\titemId: string;\r\n\t  }\r\n\t| {\r\n\t\t\tsection: \"CHECKOUT\";\r\n\t\t\torderEntity: OrderEntity;\r\n\t  }\r\n);\r\n\r\n@Injectable()\r\nexport class SectionManagerHandler {\r\n\tconstructor(\r\n\t\t@Inject(Client) private readonly client: Client,\r\n\t\tprivate readonly cartEmmbedComponent: CartEmmbedComponent,\r\n\t\tprivate readonly selectCartItemComponent: SelectCartItemComponent,\r\n\t\tprivate readonly goBackToMainSectionButionComponent: GoBackToMainSectionButionComponent,\r\n\t\tprivate readonly removeFromCartButtonComponent: RemoveFromCartButtonComponent,\r\n\t\tprivate readonly updateQuantityButtonComponent: UpdateQuantityButtonComponent,\r\n\t\tprivate readonly cancelOrderButtonComponent: CancelOrderButtonComponent,\r\n\t\tprivate readonly applyCouponButtonComponent: ApplyCouponButtonComponent,\r\n\t\tprivate readonly placeOrderButtonComponent: PlaceOrderButtonComponent,\r\n\t\tprivate readonly selectPaymentMethodComponent: SelectPaymentMethodComponent,\r\n\t\tprivate readonly viewOnWebsiteButtonComponent: ViewOnWebsiteButtonComponent,\r\n\t\tprivate readonly openDmTutorialButtonComponent: OpenDmTutorialButtonComponent,\r\n\t) {}\r\n\r\n\tasync setSection({ discordUserId, ...props }: SetSectionProps): Promise<string | MessagePayload | MessageCreateOptions> {\r\n\t\tif (props.section === \"MAIN\") {\r\n\t\t\tconst { emmbed } = await this.cartEmmbedComponent.makeCartEmmbed({ discordUserId });\r\n\t\t\tconst { row } = await this.selectCartItemComponent.createSelect({ discordUserId });\r\n\t\t\tconst { CancelCartButton } = await this.cancelOrderButtonComponent.createButton();\r\n\t\t\tconst { ApplyCouponButton } = await this.applyCouponButtonComponent.createButton({ discordUserId });\r\n\t\t\tconst { selectPaymentMethod, options } = await this.selectPaymentMethodComponent.createSelect({ discordUserId });\r\n\t\t\tconst { PlaceOrderButton } = await this.placeOrderButtonComponent.createButton({ discordUserId });\r\n\r\n\t\t\treturn {\r\n\t\t\t\tembeds: [emmbed],\r\n\t\t\t\tcomponents: [\r\n\t\t\t\t\t{ type: 1, components: [PlaceOrderButton, ApplyCouponButton, CancelCartButton] },\r\n\t\t\t\t\toptions.length > 0 ? selectPaymentMethod : undefined!,\r\n\t\t\t\t\trow,\r\n\t\t\t\t].filter(Boolean),\r\n\t\t\t\toptions: {\r\n\t\t\t\t\twithResponse: true,\r\n\t\t\t\t},\r\n\t\t\t};\r\n\t\t} else if (props.section === \"CART_ITEM\") {\r\n\t\t\tconst { emmbed } = await this.cartEmmbedComponent.makeSingleCartItemEmmbed({\r\n\t\t\t\tdiscordUserId,\r\n\t\t\t\tproductId: props.productId,\r\n\t\t\t\titemId: props.itemId,\r\n\t\t\t});\r\n\t\t\tconst { row } = await this.selectCartItemComponent.createSelect({ discordUserId, defaultItemId: props.itemId });\r\n\t\t\tconst { backToSummaryButton } = await this.goBackToMainSectionButionComponent.createButton();\r\n\t\t\tconst { removeFromCartButton } = await this.removeFromCartButtonComponent.createButton({\r\n\t\t\t\tproductId: props.productId,\r\n\t\t\t\tproductItemId: props.itemId,\r\n\t\t\t});\r\n\t\t\tconst { UpdateQuantityCartButton } = await this.updateQuantityButtonComponent.createButton({\r\n\t\t\t\tproductId: props.productId,\r\n\t\t\t\tproductItemId: props.itemId,\r\n\t\t\t});\r\n\r\n\t\t\treturn {\r\n\t\t\t\tembeds: [emmbed],\r\n\t\t\t\tcomponents: [\r\n\t\t\t\t\t{ type: 1, components: [UpdateQuantityCartButton, removeFromCartButton] },\r\n\t\t\t\t\trow,\r\n\t\t\t\t\t{ type: 1, components: [backToSummaryButton] },\r\n\t\t\t\t],\r\n\t\t\t\toptions: {\r\n\t\t\t\t\twithResponse: true,\r\n\t\t\t\t},\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tconst steps = new EmbedBuilder().setColor(BotConfig.color).setTitle(`Passos para finalizar o pedido`).setDescription(`\r\n\t\t\t\\`\\`\\`\r\nâœ… 1. Lembre-se de abrir a sua DM antes de pagar.\r\n--------------------------\r\nâœ… 2. Realize o pagamento via Pix utilizando o cÃ³digo copia e cola ou o QR Code abaixo.\r\n--------------------------\r\nâœ… 3. ApÃ³s o pagamento, seu pedido serÃ¡ processado automaticamente.\r\n--------------------------\r\nâœ… 4. Assim que o pagamento for confirmado, vocÃª receberÃ¡ seus produtos aqui na sua DM.\r\n\t\t\t\\`\\`\\`\r\n\t\t\t\t`);\r\n\r\n\t\tconst { emmbed } = await this.cartEmmbedComponent.makeCartEmmbed({\r\n\t\t\tdiscordUserId,\r\n\t\t});\r\n\t\tconst { CancelCartButton } = await this.cancelOrderButtonComponent.createButton();\r\n\t\tconst { ViewOnWebsiteButton } = await this.viewOnWebsiteButtonComponent.createButton({\r\n\t\t\torderId: props.orderEntity.id,\r\n\t\t});\r\n\t\tconst { OpenDmTutorialButton } = await this.openDmTutorialButtonComponent.createButton();\r\n\r\n\t\tif (props.orderEntity.orderProps.payment.gateway.data.hasQrCode) {\r\n\t\t\tconst qrCode = props.orderEntity.orderProps.payment.gateway.data.qrCode;\r\n\r\n\t\t\tconst base64Data = qrCode.replace(/^data:image\\/png;base64,/, \"\");\r\n\t\t\tconst attachment = new AttachmentBuilder(Buffer.from(base64Data, \"base64\"), { name: \"qrcode.png\" });\r\n\t\t\tconst qrUrl = `attachment://qrcode.png`;\r\n\r\n\t\t\tconst Pixemmbed = new EmbedBuilder()\r\n\t\t\t\t.setColor(BotConfig.color)\r\n\t\t\t\t.setTitle(`Pagamento via Pix`)\r\n\t\t\t\t.setDescription(`Para pagar via Pix, utilize o cÃ³digo abaixo no seu aplicativo bancÃ¡rio:`)\r\n\t\t\t\t.addFields({\r\n\t\t\t\t\tname: \"ðŸ”‘ **CÃ³digo copia e cola**\",\r\n\t\t\t\t\tvalue: `\\`\\`\\`${props.orderEntity.orderProps.payment.gateway.data.code}\\`\\`\\``,\r\n\t\t\t\t})\r\n\t\t\t\t.setImage(qrUrl);\r\n\r\n\t\t\treturn {\r\n\t\t\t\tembeds: [steps, Pixemmbed],\r\n\t\t\t\tcomponents: [{ type: 1, components: [ViewOnWebsiteButton, OpenDmTutorialButton, CancelCartButton] }],\r\n\t\t\t\tfiles: [attachment],\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tconst cartEmoji = await FindEmojiHelper({ client: this.client, name: \"Sharpify_carrinho\" });\r\n\r\n\t\tconst PayButton = new ButtonBuilder()\r\n\t\t\t.setLabel(\"Pagar agora\")\r\n\t\t\t.setStyle(ButtonStyle.Link)\r\n\t\t\t.setURL(props.orderEntity.orderProps.payment.gateway.data.paymentLink)\r\n\t\t\t.setEmoji({ id: cartEmoji?.id });\r\n\t\tconst ExternalLinkEmmbed = new EmbedBuilder()\r\n\t\t\t.setColor(BotConfig.color)\r\n\t\t\t.setTitle(`Pagamento via pagamento externo`)\r\n\t\t\t.setDescription(`Accesse o link externo para pagar:`);\r\n\r\n\t\treturn {\r\n\t\t\tembeds: [steps, ExternalLinkEmmbed],\r\n\t\t\tcomponents: [{ type: 1, components: [ViewOnWebsiteButton, PayButton, OpenDmTutorialButton, CancelCartButton] }],\r\n\t\t\tfiles: [],\r\n\t\t};\r\n\t}\r\n}\r\n"],"names":["SectionManagerHandler","setSection","discordUserId","props","section","emmbed","cartEmmbedComponent","makeCartEmmbed","row","selectCartItemComponent","createSelect","CancelCartButton","cancelOrderButtonComponent","createButton","ApplyCouponButton","applyCouponButtonComponent","selectPaymentMethod","options","selectPaymentMethodComponent","PlaceOrderButton","placeOrderButtonComponent","embeds","components","type","length","undefined","filter","Boolean","withResponse","makeSingleCartItemEmmbed","productId","itemId","defaultItemId","backToSummaryButton","goBackToMainSectionButionComponent","removeFromCartButton","removeFromCartButtonComponent","productItemId","UpdateQuantityCartButton","updateQuantityButtonComponent","steps","EmbedBuilder","setColor","BotConfig","color","setTitle","setDescription","ViewOnWebsiteButton","viewOnWebsiteButtonComponent","orderId","orderEntity","id","OpenDmTutorialButton","openDmTutorialButtonComponent","orderProps","payment","gateway","data","hasQrCode","qrCode","base64Data","replace","attachment","AttachmentBuilder","Buffer","from","name","qrUrl","Pixemmbed","addFields","value","code","setImage","files","cartEmoji","FindEmojiHelper","client","PayButton","ButtonBuilder","setLabel","setStyle","ButtonStyle","Link","setURL","paymentLink","setEmoji","ExternalLinkEmmbed"],"mappings":"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"}