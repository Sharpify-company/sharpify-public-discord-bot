{"version":3,"sources":["../../../../../../../src/bot/checkout/components/checkout-card/usecases/handle-order-feedback-sent/_handle-order-feedback-sent.usecase.ts"],"sourcesContent":["import { getLocalStoreConfig, Sharpify } from \"@/@shared/sharpify\";\r\nimport {\r\n\tActionRowBuilder,\r\n\tButtonBuilder,\r\n\tButtonInteraction,\r\n\tButtonStyle,\r\n\tCacheType,\r\n\tChannelType,\r\n\tClient,\r\n\tEmbedBuilder,\r\n\tGuildMember,\r\n\tPermissionsBitField,\r\n\tTextChannel,\r\n} from \"discord.js\";\r\nimport { dotEnv, formatPrice } from \"@/@shared/lib\";\r\n\r\nimport { ValidateDatabaseCartItemsHelper } from \"@/bot/checkout/helpers\";\r\nimport { Inject, Injectable } from \"@nestjs/common\";\r\nimport { DiscordUserEntity, OrderEntity } from \"@/@shared/db/entities\";\r\nimport { get } from \"http\";\r\nimport { OrderProps } from \"@/@shared/sharpify/api\";\r\nimport { BotConfig } from \"@/config\";\r\n\r\nconst sentMessages = new Set<string>();\r\nconst sentPublicMessages = new Set<string>();\r\n\r\n@Injectable()\r\nexport class HandleOrderFeedbackSentUsecase {\r\n\tconstructor(@Inject(Client) private readonly client: Client) {}\r\n\r\n\tasync sendPrivateLog({ order, discordUserId }: { order: OrderProps; discordUserId?: string }) {\r\n\t\tif (order.feedback.status !== \"SENT\") return;\r\n\r\n\t\tif (sentMessages.has(order.shortReference)) return;\r\n\t\tconst storeEntity = await getLocalStoreConfig();\r\n\t\tconst storePreferences = storeEntity.getPreferences();\r\n\t\tif (!storePreferences.feedbackPrivateLog.enabled) return;\r\n\r\n\t\tconst guild = await this.client.guilds.fetch(process.env.DISCORD_GUILD_ID!).catch(() => null);\r\n\t\tif (!guild) return;\r\n\r\n\t\tlet member: GuildMember | null = null;\r\n\r\n\t\tmember = discordUserId ? await guild.members.fetch(discordUserId).catch(() => null) : null;\r\n\r\n\t\tconst channel = (await guild.channels\r\n\t\t\t.fetch(storePreferences.feedbackPrivateLog.channelId!)\r\n\t\t\t.catch(() => null)) as TextChannel;\r\n\t\tif (!channel || channel.type !== ChannelType.GuildText) return;\r\n\r\n\t\tconst embed = new EmbedBuilder()\r\n\t\t\t.setColor(BotConfig.color)\r\n\t\t\t.setTitle(\"‚≠ê Feedback enviado. (Log privado)\")\r\n\t\t\t.setDescription(`Feedback envidado pelo cliente, veja as informa√ß√µes.`);\r\n\r\n\t\tembed.addFields([\r\n\t\t\t{\r\n\t\t\t\tname: \"`üÜî` Refer√™ncia do pedido:\",\r\n\t\t\t\tvalue: `\\`\\`\\`#${order.shortReference}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t]);\r\n\r\n\t\tembed.addFields([\r\n\t\t\t{\r\n\t\t\t\tname: `Email:`,\r\n\t\t\t\tvalue: `\\`\\`\\`${order.customer.email}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"`üìÖ` Enviado em:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${new Date(order.feedback.sentAt).toLocaleString(\"pt-br\")}\\`\\`\\``,\r\n\t\t\t\tinline: true,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: \"`üí∏` Valor do pedido:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${formatPrice(order.pricing.total)}\\`\\`\\``,\r\n\t\t\t\tinline: true,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: `\\`‚≠ê\\` Estrelas (${order.feedback.rating} de 5):`,\r\n\t\t\t\tvalue: ``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: `Comentario:`,\r\n\t\t\t\tvalue: `\\`\\`\\`${order.feedback.content || \"Nenhum comentario fornecido.\"}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t]);\r\n\r\n\t\tif (member) {\r\n\t\t\tembed.addFields([\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"`üë§` Comprador:\",\r\n\t\t\t\t\tvalue: `${member} (\\`${member.user.tag}\\`)`,\r\n\t\t\t\t},\r\n\t\t\t]);\r\n\t\t}\r\n\r\n\t\tconst viewOnWebsiteButton = new ButtonBuilder()\r\n\t\t\t.setLabel(`Visualizar no site`)\r\n\t\t\t.setStyle(ButtonStyle.Link)\r\n\t\t\t.setURL(`${storeEntity.url}/checkout/${order.id}`);\r\n\r\n\t\tawait channel\r\n\t\t\t.send({ embeds: [embed], components: [new ActionRowBuilder<ButtonBuilder>().addComponents(viewOnWebsiteButton)] })\r\n\t\t\t.catch((err) => console.log(err));\r\n\r\n\t\tsentMessages.add(order.shortReference);\r\n\t}\r\n\r\n\tasync sendPublicLog({ order, discordUserId }: { order: OrderProps; discordUserId?: string }) {\r\n\t\tif (order.feedback.status !== \"SENT\") return;\r\n\r\n\t\tif (sentPublicMessages.has(order.shortReference)) return;\r\n\t\tconst storeEntity = await getLocalStoreConfig();\r\n\t\tconst storePreferences = storeEntity.getPreferences();\r\n\t\tif (!storePreferences.feedbackPublicLog.enabled) return;\r\n\r\n\t\tconst minStars = storePreferences.feedbackPublicLog.minFeedbackStar || 4;\r\n\r\n\t\tif (order.feedback.rating < minStars) return;\r\n\r\n\t\tconst guild = await this.client.guilds.fetch(process.env.DISCORD_GUILD_ID!).catch(() => null);\r\n\t\tif (!guild) return;\r\n\r\n\t\tlet member: GuildMember | null = null;\r\n\r\n\t\tmember = discordUserId ? await guild.members.fetch(discordUserId).catch(() => null) : null;\r\n\t\tif (storePreferences.feedbackPublicLog.onlyDiscordSales && !member) return;\r\n\r\n\t\tconst channel = (await guild.channels\r\n\t\t\t.fetch(storePreferences.feedbackPublicLog.channelId!)\r\n\t\t\t.catch(() => null)) as TextChannel;\r\n\t\tif (!channel || channel.type !== ChannelType.GuildText) return;\r\n\r\n\t\tconst embed = new EmbedBuilder()\r\n\t\t\t.setColor(BotConfig.color)\r\n\t\t\t.setTitle(\"‚≠ê Feedback enviado\")\r\n\t\t\t.setDescription(`Feedback envidado pelo cliente${member ? ` ${member}` : \"\"}, veja as informa√ß√µes.`);\r\n\r\n\t\tembed.addFields([\r\n\t\t\t{\r\n\t\t\t\tname: \"`üÜî` Refer√™ncia do pedido:\",\r\n\t\t\t\tvalue: `\\`\\`\\`#${order.shortReference}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t]);\r\n\r\n\t\tembed.addFields([\r\n\t\t\t{\r\n\t\t\t\tname: \"`üìÖ` Enviado em:\",\r\n\t\t\t\tvalue: `\\`\\`\\`${new Date(order.feedback.sentAt).toLocaleString(\"pt-br\")}\\`\\`\\``,\r\n\t\t\t\tinline: true,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: `\\`‚≠ê\\` Estrelas (${order.feedback.rating} de 5):`,\r\n\t\t\t\tvalue: ``,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tname: `Comentario:`,\r\n\t\t\t\tvalue: `\\`\\`\\`${order.feedback.content || \"Nenhum comentario fornecido.\"}\\`\\`\\``,\r\n\t\t\t},\r\n\t\t]);\r\n\r\n\t\tawait channel.send({ embeds: [embed] }).catch((err) => console.log(err));\r\n\r\n\t\tsentPublicMessages.add(order.shortReference);\r\n\t}\r\n}\r\n"],"names":["HandleOrderFeedbackSentUsecase","sentMessages","Set","sentPublicMessages","sendPrivateLog","order","discordUserId","feedback","status","has","shortReference","storeEntity","getLocalStoreConfig","storePreferences","getPreferences","feedbackPrivateLog","enabled","guild","client","guilds","fetch","process","env","DISCORD_GUILD_ID","catch","member","members","channel","channels","channelId","type","ChannelType","GuildText","embed","EmbedBuilder","setColor","BotConfig","color","setTitle","setDescription","addFields","name","value","customer","email","Date","sentAt","toLocaleString","inline","formatPrice","pricing","total","rating","content","user","tag","viewOnWebsiteButton","ButtonBuilder","setLabel","setStyle","ButtonStyle","Link","setURL","url","id","send","embeds","components","ActionRowBuilder","addComponents","err","console","log","add","sendPublicLog","feedbackPublicLog","minStars","minFeedbackStar","onlyDiscordSales"],"mappings":"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"}