{"version":3,"sources":["../../../../src/bot/checkout/helpers/validate-database-cart-items.helper.ts"],"sourcesContent":["import { DiscordUserEntity, ProductEntity } from \"@/@shared/db/entities\";\r\nimport { Either } from \"@/@shared/lib\";\r\nimport { Sharpify } from \"@/@shared/sharpify\";\r\nimport { ProductProps } from \"@/@shared/sharpify/api\";\r\n\r\nfunction findProductItemFromProduct({ product, productItemId }: { productItemId: string; product: ProductEntity }) {\r\n\treturn product.productProps.settings.viewType === \"NORMAL\"\r\n\t\t? product.productProps.normalItem.id === productItemId\r\n\t\t\t? product.productProps.normalItem\r\n\t\t\t: undefined\r\n\t\t: product.productProps.dynamicItems.find((v) => v.id === productItemId);\r\n}\r\n\r\nexport async function ValidateDatabaseCartItemsHelper({ discordUserId }: { discordUserId: string }) {\r\n\tconst user = await DiscordUserEntity.findOneBy({ id: discordUserId });\r\n\tif (!user) return;\r\n\r\n\tconst productIds = user.cart.cartItems.reduce((acc, item) => {\r\n\t\tif (!acc.includes(item.productId)) {\r\n\t\t\tacc.push(item.productId);\r\n\t\t}\r\n\t\treturn acc;\r\n\t}, [] as string[]);\r\n\r\n\tconst productEntities: ProductEntity[] = [];\r\n\tfor (const productId of productIds) {\r\n\t\tconst product = await ProductEntity.findOneBy({ id: productId });\r\n\t\tproduct && productEntities.push(product);\r\n\t}\r\n\r\n\tconst couponReq = user.cart.couponCode\r\n\t\t? await Sharpify.api.v1.pricing.coupon.validateCoupon({ code: user.cart.couponCode })\r\n\t\t: null;\r\n\tconst coupon = couponReq?.success ? couponReq.data.coupon : null;\r\n\tconst allProductsWithCouponApplied = productEntities.filter((product) =>\r\n\t\tcoupon?.useCondition?.productIds?.includes(product.id),\r\n\t);\r\n\tif (coupon && coupon.useCondition?.productIds && allProductsWithCouponApplied.length === 0) {\r\n\t\t// Coupon no longer valid for any products in cart, remove it\r\n\t\tuser.cart.couponCode = null;\r\n\t}\r\n\r\n\tlet fixedDiscountPerProduct = 0;\r\n\tlet fixedDiscountRemainder = 0;\r\n\tif (coupon?.type === \"FIXED\" && allProductsWithCouponApplied.length > 0) {\r\n\t\tfixedDiscountPerProduct = coupon?.amout / allProductsWithCouponApplied.length;\r\n\t\tif (fixedDiscountPerProduct < 0.01) fixedDiscountPerProduct = 0;\r\n\t}\r\n\r\n\tfor (const cartItem of user.cart.cartItems) {\r\n\t\tconst isCouponApplied = !!allProductsWithCouponApplied.find((p) => p.id === cartItem.productId);\r\n\r\n\t\tconst product = productEntities.find((p) => p.id === cartItem.productId);\r\n\t\tif (!product) {\r\n\t\t\t// Product no longer exists, remove from cart\r\n\t\t\tuser.cart.removeFromCart({ productId: cartItem.productId, productItemId: cartItem.productItemId });\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst productItem = findProductItemFromProduct({ product, productItemId: cartItem.productItemId });\r\n\r\n\t\tif (!productItem) {\r\n\t\t\t// Product item no longer exists, remove from cart\r\n\t\t\tconsole.log(\"ðŸš€ ~ ValidateDatabaseCartItemsHelper ~ productItem:\", productItem);\r\n\t\t\tuser.cart.removeFromCart({ productId: cartItem.productId, productItemId: cartItem.productItemId });\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (productItem.inventory.stockQuantity !== null && cartItem.quantity > productItem.inventory.stockQuantity) {\r\n\t\t\t// Adjust quantity to available stock\r\n\t\t\tcartItem.quantity = productItem.inventory.stockQuantity;\r\n\t\t\tif (cartItem.quantity <= 0) {\r\n\t\t\t\tuser.cart.removeFromCart({ productId: cartItem.productId, productItemId: cartItem.productItemId });\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t}\r\n\t\tcartItem.subTotalPrice = productItem.pricing.price * cartItem.quantity;\r\n\t\tcartItem.totalPrice = cartItem.subTotalPrice;\r\n\r\n\t\tconst subTotal = productItem.pricing.price * cartItem.quantity;\r\n\t\tlet total = subTotal;\r\n\t\tlet discountAmount = 0;\r\n\r\n\t\tif (coupon && isCouponApplied) {\r\n\t\t\tif (coupon.type === \"PERCENTAGE\") {\r\n\t\t\t\tdiscountAmount = (total * coupon.amout) / 100;\r\n\t\t\t\ttotal = total - discountAmount;\r\n\t\t\t} else if (coupon.type === \"FIXED\") {\r\n\t\t\t\tdiscountAmount = fixedDiscountPerProduct;\r\n\t\t\t\ttotal = total - discountAmount - fixedDiscountRemainder;\r\n\t\t\t\tfixedDiscountRemainder = 0;\r\n\r\n\t\t\t\tif (total < 0) {\r\n\t\t\t\t\tfixedDiscountRemainder += Math.abs(total);\r\n\t\t\t\t\ttotal = 0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tcartItem.totalPrice = total;\r\n\t\tcartItem.subTotalPrice = subTotal;\r\n\t\tcartItem.isCouponApplied = isCouponApplied;\r\n\t}\r\n\r\n\tconst subTotal = user.cart.cartItems.reduce((acc, item) => acc + item.subTotalPrice, 0);\r\n\tlet total = user.cart.cartItems.reduce((acc, item) => acc + item.totalPrice, 0);\r\n\r\n\tuser.cart.subTotalPrice = subTotal;\r\n\tuser.cart.totalPrice = total;\r\n\r\n\tawait user.save();\r\n}\r\n"],"names":["ValidateDatabaseCartItemsHelper","findProductItemFromProduct","product","productItemId","productProps","settings","viewType","normalItem","id","undefined","dynamicItems","find","v","discordUserId","user","DiscordUserEntity","findOneBy","productIds","cart","cartItems","reduce","acc","item","includes","productId","push","productEntities","ProductEntity","couponReq","couponCode","Sharpify","api","v1","pricing","coupon","validateCoupon","code","success","data","allProductsWithCouponApplied","filter","useCondition","length","fixedDiscountPerProduct","fixedDiscountRemainder","type","amout","cartItem","isCouponApplied","p","removeFromCart","productItem","console","log","inventory","stockQuantity","quantity","subTotalPrice","price","totalPrice","subTotal","total","discountAmount","Math","abs","save"],"mappings":"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"}