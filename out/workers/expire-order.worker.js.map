{"version":3,"sources":["../../src/workers/expire-order.worker.ts"],"sourcesContent":["import { DiscordUserEntity, ExternalEventsEntity } from \"@/@shared/db/entities\";\r\nimport { Sharpify } from \"@/@shared/sharpify\";\r\nimport { Inject, Injectable, OnModuleInit } from \"@nestjs/common\";\r\nimport { Cron } from \"@nestjs/schedule\";\r\nimport { HandleProductEvent } from \"./usecases\";\r\nimport { Client } from \"discord.js\";\r\nimport { LessThan } from \"typeorm\";\r\nimport { subMinutes } from \"date-fns\";\r\n\r\n@Injectable()\r\nexport class ExpireOrderWorker {\r\n\tconstructor(@Inject(Client) private readonly client: Client) {}\r\n\r\n\t@Cron(\"*/15 * * * * *\")\r\n\thandleCron() {\r\n\t\tthis.execute();\r\n\t}\r\n\r\n\tasync execute() {\r\n\t\tconst users = await DiscordUserEntity.findBy({\r\n\t\t\tcart: {\r\n\t\t\t\tcartCreatedAt: LessThan(subMinutes(new Date(), 15)),\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tfor (const userEntity of users) {\r\n\t\t\tconst channel = await this.client.channels.fetch(userEntity.cart.channelId).catch(() => null);\r\n\t\t\tawait channel?.delete().catch(() => null);\r\n\r\n\t\t\tawait userEntity.cart.cancelOrder();\r\n\t\t}\r\n\t}\r\n}\r\n"],"names":["ExpireOrderWorker","handleCron","execute","users","DiscordUserEntity","findBy","cart","cartCreatedAt","LessThan","subMinutes","Date","userEntity","channel","client","channels","fetch","channelId","catch","delete","cancelOrder"],"mappings":";;;;+BAUaA;;;eAAAA;;;0BAV2C;wBAEP;0BAC5B;yBAEE;yBACE;yBACE;;;;;;;;;;;;;;;AAGpB,IAAA,AAAMA,oBAAN,MAAMA;IAIZC,aAAa;QACZ,IAAI,CAACC,OAAO;IACb;IAEA,MAAMA,UAAU;QACf,MAAMC,QAAQ,MAAMC,2BAAiB,CAACC,MAAM,CAAC;YAC5CC,MAAM;gBACLC,eAAeC,IAAAA,iBAAQ,EAACC,IAAAA,mBAAU,EAAC,IAAIC,QAAQ;YAChD;QACD;QAEA,KAAK,MAAMC,cAAcR,MAAO;YAC/B,MAAMS,UAAU,MAAM,IAAI,CAACC,MAAM,CAACC,QAAQ,CAACC,KAAK,CAACJ,WAAWL,IAAI,CAACU,SAAS,EAAEC,KAAK,CAAC,IAAM;YACxF,MAAML,SAASM,SAASD,MAAM,IAAM;YAEpC,MAAMN,WAAWL,IAAI,CAACa,WAAW;QAClC;IACD;IApBA,YAAY,AAAiCN,MAAc,CAAE;aAAhBA,SAAAA;IAAiB;AAqB/D"}